<!DOCTYPE html>
<html class="writer-html5" lang="en" data-content_root="../../../">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>vyperdatum.utils.vdatum_rest_utils &mdash; Vyperdatum 0.1.1 documentation</title>
      <link rel="stylesheet" type="text/css" href="../../../_static/pygments.css?v=80d5e7a1" />
      <link rel="stylesheet" type="text/css" href="../../../_static/css/theme.css?v=19f00094" />

  
  <!--[if lt IE 9]>
    <script src="../../../_static/js/html5shiv.min.js"></script>
  <![endif]-->
  
        <script src="../../../_static/jquery.js?v=5d32c60e"></script>
        <script src="../../../_static/_sphinx_javascript_frameworks_compat.js?v=2cd50e6c"></script>
        <script src="../../../_static/documentation_options.js?v=a58bc63e"></script>
        <script src="../../../_static/doctools.js?v=9a2dae69"></script>
        <script src="../../../_static/sphinx_highlight.js?v=dc90522c"></script>
    <script src="../../../_static/js/theme.js"></script>
    <link rel="index" title="Index" href="../../../genindex.html" />
    <link rel="search" title="Search" href="../../../search.html" /> 
</head>

<body class="wy-body-for-nav"> 
  <div class="wy-grid-for-nav">
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search" >

          
          
          <a href="../../../index.html" class="icon icon-home">
            Vyperdatum
          </a>
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../../../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" aria-label="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>
        </div><div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="Navigation menu">
              <p class="caption" role="heading"><span class="caption-text">Contents:</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../../modules.html">vyperdatum</a></li>
</ul>

        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap"><nav class="wy-nav-top" aria-label="Mobile navigation menu" >
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../../../index.html">Vyperdatum</a>
      </nav>

      <div class="wy-nav-content">
        <div class="rst-content">
          <div role="navigation" aria-label="Page navigation">
  <ul class="wy-breadcrumbs">
      <li><a href="../../../index.html" class="icon icon-home" aria-label="Home"></a></li>
          <li class="breadcrumb-item"><a href="../../index.html">Module code</a></li>
      <li class="breadcrumb-item active">vyperdatum.utils.vdatum_rest_utils</li>
      <li class="wy-breadcrumbs-aside">
      </li>
  </ul>
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
             
  <h1>Source code for vyperdatum.utils.vdatum_rest_utils</h1><div class="highlight"><pre>
<span></span><span class="kn">import</span> <span class="nn">requests</span>
<span class="kn">import</span> <span class="nn">logging</span>
<span class="kn">import</span> <span class="nn">time</span>
<span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>
<span class="kn">import</span> <span class="nn">pandas</span> <span class="k">as</span> <span class="nn">pd</span>
<span class="kn">from</span> <span class="nn">colorama</span> <span class="kn">import</span> <span class="n">Fore</span><span class="p">,</span> <span class="n">Style</span>
<span class="kn">from</span> <span class="nn">osgeo</span> <span class="kn">import</span> <span class="n">gdal</span>
<span class="kn">from</span> <span class="nn">typing</span> <span class="kn">import</span> <span class="n">Optional</span>
<span class="kn">import</span> <span class="nn">pyproj</span> <span class="k">as</span> <span class="nn">pp</span>
<span class="kn">from</span> <span class="nn">tqdm</span> <span class="kn">import</span> <span class="n">tqdm</span>
<span class="kn">import</span> <span class="nn">difflib</span>
<span class="kn">from</span> <span class="nn">vyperdatum.enums</span> <span class="kn">import</span> <span class="n">VDATUM</span>
<span class="kn">from</span> <span class="nn">vyperdatum.utils.raster_utils</span> <span class="kn">import</span> <span class="n">raster_metadata</span>


<span class="n">logger</span> <span class="o">=</span> <span class="n">logging</span><span class="o">.</span><span class="n">getLogger</span><span class="p">(</span><span class="s2">&quot;root_logger&quot;</span><span class="p">)</span>
<span class="n">gdal</span><span class="o">.</span><span class="n">UseExceptions</span><span class="p">()</span>


<div class="viewcode-block" id="vdatum_transform_point">
<a class="viewcode-back" href="../../../vyperdatum.utils.html#vyperdatum.utils.vdatum_rest_utils.vdatum_transform_point">[docs]</a>
<span class="k">def</span> <span class="nf">vdatum_transform_point</span><span class="p">(</span><span class="n">s_x</span><span class="p">,</span> <span class="n">s_y</span><span class="p">,</span> <span class="n">s_z</span><span class="p">,</span> <span class="n">region</span><span class="p">,</span>
                           <span class="n">s_h_frame</span><span class="p">,</span> <span class="n">s_v_frame</span><span class="p">,</span> <span class="n">s_h_zone</span><span class="p">,</span>
                           <span class="n">t_h_frame</span><span class="p">,</span> <span class="n">t_v_frame</span><span class="p">,</span> <span class="n">t_h_zone</span><span class="p">,</span>
                           <span class="n">s_v_goid</span><span class="o">=</span><span class="s2">&quot;geoid18&quot;</span><span class="p">,</span>
                           <span class="n">t_v_goid</span><span class="o">=</span><span class="s2">&quot;geoid18&quot;</span><span class="p">,</span>
                           <span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Call point transformation GET endpoint (/convert) of the Vdatum REST API.</span>
<span class="sd">    API docs: https://vdatum.noaa.gov/docs/services.html</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    s_x: float</span>
<span class="sd">        Source point longitude</span>
<span class="sd">    s_y: float</span>
<span class="sd">        Source point latitude</span>
<span class="sd">    s_z: float</span>
<span class="sd">        Source point height</span>
<span class="sd">    region: str</span>
<span class="sd">        Vdatum region name (e.g. ak, as, contiguous, gcnmi, prvi)</span>
<span class="sd">        https://vdatum.noaa.gov/docs/services.html#step140</span>
<span class="sd">    s_h_frame: str</span>
<span class="sd">        Source horizontal reference frame (e.g. NAD83_2011)</span>
<span class="sd">        https://vdatum.noaa.gov/docs/services.html#step150</span>
<span class="sd">    s_v_frame: str</span>
<span class="sd">        source vertical reference frame (e.g. NAVD88, PRVD02, MLLW)</span>
<span class="sd">        https://vdatum.noaa.gov/docs/services.html#step160</span>
<span class="sd">    t_h_frame: str</span>
<span class="sd">        Target horizontal reference frame (e.g. NAD83_2011)</span>
<span class="sd">        https://vdatum.noaa.gov/docs/services.html#step150</span>
<span class="sd">    t_v_frame: str</span>
<span class="sd">        Target vertical reference frame (e.g. NAVD88, PRVD02, MLLW)</span>
<span class="sd">        https://vdatum.noaa.gov/docs/services.html#step160</span>
<span class="sd">    s_v_goid: str</span>
<span class="sd">        Source vertical GEOID model (e.g. geoid18 (default), geoid12b,</span>
<span class="sd">        geoid12a, geoid09, geoid06, geoid03, geoid99, geoid96, egm2008,</span>
<span class="sd">        egm1996, egm1984, xgeoid16b, xgeoid17b, xgeoid18b, xgeoid19b,</span>
<span class="sd">        xgeoid20b)</span>
<span class="sd">    t_v_goid: str</span>
<span class="sd">        Target vertical GEOID model (e.g. geoid18 (default), geoid12b,</span>
<span class="sd">        geoid12a, geoid09, geoid06, geoid03, geoid99, geoid96, egm2008,</span>
<span class="sd">        egm1996, egm1984, xgeoid16b, xgeoid17b, xgeoid18b, xgeoid19b,</span>
<span class="sd">        xgeoid20b)</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    Optional[tuple]</span>
<span class="sd">        The transformed coordinates (lon, lat, height)</span>
<span class="sd">    Optional[dict]</span>
<span class="sd">        The complete vdatum response object</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">url</span> <span class="o">=</span> <span class="s2">&quot;https://vdatum.noaa.gov/vdatumweb/api/convert&quot;</span>
    <span class="n">params</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span><span class="n">s_x</span><span class="o">=</span><span class="n">s_x</span><span class="p">,</span> <span class="n">s_y</span><span class="o">=</span><span class="n">s_y</span><span class="p">,</span> <span class="n">s_z</span><span class="o">=</span><span class="n">s_z</span><span class="p">,</span> <span class="n">region</span><span class="o">=</span><span class="n">region</span><span class="p">,</span>
                  <span class="n">s_h_frame</span><span class="o">=</span><span class="n">s_h_frame</span><span class="p">,</span> <span class="n">s_v_frame</span><span class="o">=</span><span class="n">s_v_frame</span><span class="p">,</span>
                  <span class="n">s_h_zone</span><span class="o">=</span><span class="n">s_h_zone</span> <span class="k">if</span> <span class="n">s_h_zone</span> <span class="k">else</span> <span class="s2">&quot;&quot;</span><span class="p">,</span>
                  <span class="n">t_h_frame</span><span class="o">=</span><span class="n">t_h_frame</span><span class="p">,</span> <span class="n">t_v_frame</span><span class="o">=</span><span class="n">t_v_frame</span><span class="p">,</span>
                  <span class="n">t_h_zone</span><span class="o">=</span><span class="n">t_h_zone</span> <span class="k">if</span> <span class="n">t_h_zone</span> <span class="k">else</span> <span class="s2">&quot;&quot;</span><span class="p">,</span>
                  <span class="n">s_v_goid</span><span class="o">=</span><span class="n">s_v_goid</span><span class="p">,</span> <span class="n">t_v_goid</span><span class="o">=</span><span class="n">t_v_goid</span><span class="p">)</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="n">resp</span> <span class="o">=</span> <span class="n">requests</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">url</span><span class="p">,</span> <span class="n">params</span><span class="o">=</span><span class="n">params</span><span class="p">,</span> <span class="n">timeout</span><span class="o">=</span><span class="mi">200</span><span class="p">)</span><span class="o">.</span><span class="n">json</span><span class="p">()</span>
        <span class="n">time</span><span class="o">.</span><span class="n">sleep</span><span class="p">(</span><span class="mf">0.5</span><span class="p">)</span>
    <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">exception</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;VDatum API exception:</span><span class="se">\n</span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="k">return</span> <span class="kc">None</span><span class="p">,</span> <span class="kc">None</span>
    <span class="k">return</span> <span class="p">(</span><span class="nb">float</span><span class="p">(</span><span class="n">resp</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;t_x&quot;</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">nan</span><span class="p">)),</span>
            <span class="nb">float</span><span class="p">(</span><span class="n">resp</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;t_y&quot;</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">nan</span><span class="p">)),</span>
            <span class="nb">float</span><span class="p">(</span><span class="n">resp</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;t_z&quot;</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">nan</span><span class="p">))),</span> <span class="n">resp</span></div>



<div class="viewcode-block" id="api_region_alias">
<a class="viewcode-back" href="../../../vyperdatum.utils.html#vyperdatum.utils.vdatum_rest_utils.api_region_alias">[docs]</a>
<span class="k">def</span> <span class="nf">api_region_alias</span><span class="p">(</span><span class="n">region</span><span class="p">:</span> <span class="nb">str</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Vdatum REST api uses different region names compared to those</span>
<span class="sd">    listed in the vdatum grids directory. This function expects to</span>
<span class="sd">    receive region name according to the vdatum grids directory and</span>
<span class="sd">    returns region name consistent with the vdatum REST api. Default</span>
<span class="sd">    output is `contiguous`.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ------------</span>
<span class="sd">    region: str</span>
<span class="sd">         Region name according to the vdatum grids directory.</span>

<span class="sd">    Returns</span>
<span class="sd">    ------------</span>
<span class="sd">    str</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">api_region</span> <span class="o">=</span> <span class="s2">&quot;contiguous&quot;</span>
    <span class="k">if</span> <span class="n">region</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s2">&quot;AK&quot;</span><span class="p">):</span>
        <span class="n">api_region</span> <span class="o">=</span> <span class="s2">&quot;ak&quot;</span>
    <span class="k">elif</span> <span class="n">region</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s2">&quot;WA&quot;</span><span class="p">)</span> <span class="ow">or</span> <span class="n">region</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s2">&quot;OR&quot;</span><span class="p">)</span> <span class="ow">or</span> <span class="n">region</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s2">&quot;WC&quot;</span><span class="p">):</span>
        <span class="n">api_region</span> <span class="o">=</span> <span class="s2">&quot;westcoast&quot;</span>
    <span class="k">elif</span> <span class="n">region</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s2">&quot;PRVI&quot;</span><span class="p">):</span>
        <span class="n">api_region</span> <span class="o">=</span> <span class="s2">&quot;prvi&quot;</span>
    <span class="c1"># Note: not all regions are covered here. For example, I do&#39;nt know what is the Hawaii</span>
    <span class="c1"># region name in vdatum grid directory (or as, sgi, spi, sli, gcnmi, wgom, ...).</span>
    <span class="c1"># why `westcoast` and `chesapeak_delaware` are not considered as part of `contiguous`?.</span>
    <span class="c1"># Needs input from others.</span>
    <span class="c1"># https://vdatum.noaa.gov/docs/services.html#step140</span>
    <span class="k">return</span> <span class="n">api_region</span></div>



<div class="viewcode-block" id="wkt_to_utm">
<a class="viewcode-back" href="../../../vyperdatum.utils.html#vyperdatum.utils.vdatum_rest_utils.wkt_to_utm">[docs]</a>
<span class="k">def</span> <span class="nf">wkt_to_utm</span><span class="p">(</span><span class="n">wkt</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Receives WKT and returns the UTM zone, if applicable.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ------------</span>
<span class="sd">    wkt: str</span>
<span class="sd">         WKT string</span>

<span class="sd">    Returns</span>
<span class="sd">    ------------</span>
<span class="sd">    Optional[str]</span>
<span class="sd">         UTM zone</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">zone</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="n">input_crs</span> <span class="o">=</span> <span class="n">pp</span><span class="o">.</span><span class="n">CRS</span><span class="p">(</span><span class="n">wkt</span><span class="p">)</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">input_crs</span><span class="o">.</span><span class="n">is_projected</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">zone</span>
    <span class="n">input_crs</span> <span class="o">=</span> <span class="n">input_crs</span><span class="o">.</span><span class="n">name</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;+&quot;</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span>
    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">input_crs</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;/ UTM zone &quot;</span><span class="p">))</span> <span class="o">==</span> <span class="mi">2</span><span class="p">:</span>
        <span class="n">zone</span> <span class="o">=</span> <span class="n">input_crs</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;/ UTM zone &quot;</span><span class="p">)[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span>
    <span class="k">return</span> <span class="n">zone</span></div>



<div class="viewcode-block" id="wkt_to_crs">
<a class="viewcode-back" href="../../../vyperdatum.utils.html#vyperdatum.utils.vdatum_rest_utils.wkt_to_crs">[docs]</a>
<span class="k">def</span> <span class="nf">wkt_to_crs</span><span class="p">(</span><span class="n">wkt</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">tuple</span><span class="p">[</span><span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">],</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]]:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Receives WKT and returns the horizontal/vertical CRS names.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ------------</span>
<span class="sd">    wkt: str</span>
<span class="sd">         WKT string</span>

<span class="sd">    Returns</span>
<span class="sd">    ------------</span>
<span class="sd">    tuple[Optional[str], Optional[str]]</span>
<span class="sd">         Horizontal and vertical CRS names, if identified.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">input_crs</span> <span class="o">=</span> <span class="n">pp</span><span class="o">.</span><span class="n">CRS</span><span class="p">(</span><span class="n">wkt</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">input_crs</span><span class="o">.</span><span class="n">is_compound</span><span class="p">:</span>
        <span class="n">horizontal_crs</span> <span class="o">=</span> <span class="n">pp</span><span class="o">.</span><span class="n">CRS</span><span class="p">(</span><span class="n">input_crs</span><span class="o">.</span><span class="n">sub_crs_list</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
        <span class="n">vertical_crs</span> <span class="o">=</span> <span class="n">pp</span><span class="o">.</span><span class="n">CRS</span><span class="p">(</span><span class="n">input_crs</span><span class="o">.</span><span class="n">sub_crs_list</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">horizontal_crs</span> <span class="o">=</span> <span class="n">input_crs</span>
        <span class="n">vertical_crs</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="k">return</span> <span class="n">horizontal_crs</span><span class="o">.</span><span class="n">name</span><span class="p">,</span> <span class="n">vertical_crs</span><span class="o">.</span><span class="n">name</span> <span class="k">if</span> <span class="n">vertical_crs</span> <span class="k">else</span> <span class="kc">None</span></div>



<div class="viewcode-block" id="api_crs_aliases">
<a class="viewcode-back" href="../../../vyperdatum.utils.html#vyperdatum.utils.vdatum_rest_utils.api_crs_aliases">[docs]</a>
<span class="k">def</span> <span class="nf">api_crs_aliases</span><span class="p">(</span><span class="n">wkt</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">tuple</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">str</span><span class="p">]:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Vdatum REST api uses different CRS names compared to those</span>
<span class="sd">    of the PROJ/pyproj. This function expects to receive a CRS WKT</span>
<span class="sd">    and returns horizontal and vertical CRS names that are consumable</span>
<span class="sd">    by the vdatum REST api.</span>

<span class="sd">    Raises</span>
<span class="sd">    ------------</span>
<span class="sd">    ValueError</span>
<span class="sd">         When the standard CRS name can&#39;t be matched with any Vdatum API CRS names.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ------------</span>
<span class="sd">    wkt: str</span>
<span class="sd">         WKT string.</span>

<span class="sd">    Returns</span>
<span class="sd">    ------------</span>
<span class="sd">    tuple[str, str]</span>
<span class="sd">        Horizontal and vertical CRS names that are consumable by the vdatum REST api.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">h_crs</span><span class="p">,</span> <span class="n">v_crs</span> <span class="o">=</span> <span class="n">wkt_to_crs</span><span class="p">(</span><span class="n">wkt</span><span class="p">)</span>
    <span class="n">h_crs</span> <span class="o">=</span> <span class="n">h_crs</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;/&quot;</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span>
    <span class="n">h_matches</span> <span class="o">=</span> <span class="n">difflib</span><span class="o">.</span><span class="n">get_close_matches</span><span class="p">(</span><span class="n">h_crs</span><span class="p">,</span> <span class="n">VDATUM</span><span class="o">.</span><span class="n">H_FRAMES</span><span class="o">.</span><span class="n">value</span><span class="p">)</span>
    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">h_matches</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;No Vdatum horizontal CRS name matched with &#39;</span><span class="si">{</span><span class="n">h_crs</span><span class="si">}</span><span class="s2">&#39;&quot;</span><span class="p">)</span>
    <span class="n">h_crs</span> <span class="o">=</span> <span class="n">h_matches</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>

    <span class="n">v_crs_black</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;HRD&quot;</span><span class="p">]</span>
    <span class="k">if</span> <span class="n">v_crs</span> <span class="ow">and</span> <span class="n">v_crs</span><span class="o">.</span><span class="n">split</span><span class="p">()[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">upper</span><span class="p">()</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span> <span class="ow">in</span> <span class="n">v_crs_black</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;The raster&#39;s vertical CRS is &#39;</span><span class="si">{</span><span class="n">v_crs</span><span class="si">}</span><span class="s2">&#39; which is not covered by Vdatum.&quot;</span><span class="p">)</span>

    <span class="k">if</span> <span class="ow">not</span> <span class="n">v_crs</span><span class="p">:</span>
        <span class="n">v_crs</span> <span class="o">=</span> <span class="n">h_crs</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">v_matches</span> <span class="o">=</span> <span class="n">difflib</span><span class="o">.</span><span class="n">get_close_matches</span><span class="p">(</span><span class="n">v_crs</span><span class="p">,</span> <span class="n">VDATUM</span><span class="o">.</span><span class="n">V_FRAMES</span><span class="o">.</span><span class="n">value</span><span class="p">)</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">v_matches</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">v_matches</span> <span class="o">=</span> <span class="n">difflib</span><span class="o">.</span><span class="n">get_close_matches</span><span class="p">(</span><span class="n">v_crs</span><span class="o">.</span><span class="n">split</span><span class="p">()[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">strip</span><span class="p">(),</span> <span class="n">VDATUM</span><span class="o">.</span><span class="n">V_FRAMES</span><span class="o">.</span><span class="n">value</span><span class="p">)</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">v_matches</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">v_matches</span> <span class="o">=</span> <span class="n">difflib</span><span class="o">.</span><span class="n">get_close_matches</span><span class="p">(</span><span class="n">v_crs</span><span class="o">.</span><span class="n">split</span><span class="p">()[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">strip</span><span class="p">(),</span> <span class="n">VDATUM</span><span class="o">.</span><span class="n">V_FRAMES</span><span class="o">.</span><span class="n">value</span><span class="p">)</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;No Vdatum vertical CRS name matched with &#39;</span><span class="si">{</span><span class="n">v_crs</span><span class="si">}</span><span class="s2">&#39;&quot;</span><span class="p">)</span>
        <span class="n">v_crs</span> <span class="o">=</span> <span class="n">v_matches</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
    <span class="k">return</span> <span class="n">h_crs</span><span class="p">,</span> <span class="n">v_crs</span></div>



<div class="viewcode-block" id="index_to_xy">
<a class="viewcode-back" href="../../../vyperdatum.utils.html#vyperdatum.utils.vdatum_rest_utils.index_to_xy">[docs]</a>
<span class="k">def</span> <span class="nf">index_to_xy</span><span class="p">(</span><span class="n">i</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span> <span class="n">j</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span> <span class="n">geot</span><span class="p">:</span> <span class="nb">tuple</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Take indices of a raster&#39;s band array and return x, y.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    i: int</span>
<span class="sd">        Raster&#39;s band array first index.</span>
<span class="sd">    j: int</span>
<span class="sd">        Raster&#39;s band array second index.</span>
<span class="sd">    geot: tuple</span>
<span class="sd">        Gdal GeoTransform tuple object.</span>

<span class="sd">    Returns</span>
<span class="sd">    ----------</span>
<span class="sd">    float, float</span>
<span class="sd">        easting, northing</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">res_x</span><span class="p">,</span> <span class="n">res_y</span> <span class="o">=</span> <span class="n">geot</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">geot</span><span class="p">[</span><span class="mi">5</span><span class="p">]</span>
    <span class="n">x_min</span><span class="p">,</span> <span class="n">y_max</span> <span class="o">=</span> <span class="n">geot</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">geot</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span>
    <span class="n">x</span> <span class="o">=</span> <span class="n">j</span> <span class="o">*</span> <span class="n">res_x</span> <span class="o">+</span> <span class="n">x_min</span> <span class="o">+</span> <span class="p">(</span><span class="n">res_x</span> <span class="o">/</span> <span class="mf">2.0</span><span class="p">)</span>
    <span class="n">y</span> <span class="o">=</span> <span class="n">i</span> <span class="o">*</span> <span class="n">res_y</span> <span class="o">+</span> <span class="n">y_max</span> <span class="o">+</span> <span class="p">(</span><span class="n">res_y</span> <span class="o">/</span> <span class="mf">2.0</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">x</span><span class="p">,</span> <span class="n">y</span></div>



<div class="viewcode-block" id="sample_raster">
<a class="viewcode-back" href="../../../vyperdatum.utils.html#vyperdatum.utils.vdatum_rest_utils.sample_raster">[docs]</a>
<span class="k">def</span> <span class="nf">sample_raster</span><span class="p">(</span><span class="n">source_meta</span><span class="p">:</span> <span class="nb">dict</span><span class="p">,</span>
                  <span class="n">target_meta</span><span class="p">:</span> <span class="nb">dict</span><span class="p">,</span>
                  <span class="n">n_sample</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span>
                  <span class="n">sampling_band</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span>
                  <span class="n">pivot_h_crs</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span>
                  <span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">tuple</span><span class="p">[</span><span class="nb">list</span><span class="p">,</span> <span class="nb">list</span><span class="p">]:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Randomly draw `n_samples` points (not NoDataValue) from the `sampling_band`</span>
<span class="sd">    of the source and target rasters.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    source_meta: dict</span>
<span class="sd">        Source raster metadata generated by `raster_metadata` function.</span>
<span class="sd">    target_meta: dict</span>
<span class="sd">        Target raster metadata generated by `raster_metadata` function.</span>
<span class="sd">    n_sample: int</span>
<span class="sd">        The number of sample points (coordinates).</span>
<span class="sd">    sampling_band: dict</span>
<span class="sd">        The index of the source band to be sampled (default 1).</span>
<span class="sd">    pivot_h_crs: Optional[str]</span>
<span class="sd">        When not None, both source and target samples are transformed</span>
<span class="sd">        into a common horizontal CRS, otherwise ignored (default None).</span>
<span class="sd">        Example: pivot_h_crs = &#39;EPSG:6318&#39;</span>

<span class="sd">    Raises</span>
<span class="sd">    -------</span>
<span class="sd">    ValueError:</span>
<span class="sd">        If there are less not-null values than `n_sample` in the target raster band.</span>

<span class="sd">    Returns</span>
<span class="sd">    ----------</span>
<span class="sd">    bool</span>
<span class="sd">        Returns `n_samples` points from the rasters in form of two lists of [x, y, sampled_value].</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">ds_source</span> <span class="o">=</span> <span class="n">gdal</span><span class="o">.</span><span class="n">Open</span><span class="p">(</span><span class="n">source_meta</span><span class="p">[</span><span class="s2">&quot;path&quot;</span><span class="p">])</span>
    <span class="n">ds_target</span> <span class="o">=</span> <span class="n">gdal</span><span class="o">.</span><span class="n">Open</span><span class="p">(</span><span class="n">target_meta</span><span class="p">[</span><span class="s2">&quot;path&quot;</span><span class="p">])</span>
    <span class="n">bar_source</span> <span class="o">=</span> <span class="n">ds_source</span><span class="o">.</span><span class="n">GetRasterBand</span><span class="p">(</span><span class="n">sampling_band</span><span class="p">)</span><span class="o">.</span><span class="n">ReadAsArray</span><span class="p">()</span>
    <span class="n">bar_target</span> <span class="o">=</span> <span class="n">ds_target</span><span class="o">.</span><span class="n">GetRasterBand</span><span class="p">(</span><span class="n">sampling_band</span><span class="p">)</span><span class="o">.</span><span class="n">ReadAsArray</span><span class="p">()</span>
    <span class="n">nodata_value</span> <span class="o">=</span> <span class="n">ds_target</span><span class="o">.</span><span class="n">GetRasterBand</span><span class="p">(</span><span class="n">sampling_band</span><span class="p">)</span><span class="o">.</span><span class="n">GetNoDataValue</span><span class="p">()</span>
    <span class="k">if</span> <span class="n">np</span><span class="o">.</span><span class="n">count_nonzero</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">bar_target</span> <span class="o">!=</span> <span class="n">nodata_value</span><span class="p">))</span> <span class="o">&lt;</span> <span class="n">n_sample</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Cannot sample </span><span class="si">{</span><span class="n">n_sample</span><span class="si">}</span><span class="s2"> from the target raster. Too many NoDataValue.&quot;</span><span class="p">)</span>
    <span class="n">source_samples</span><span class="p">,</span> <span class="n">target_samples</span> <span class="o">=</span> <span class="p">[],</span> <span class="p">[]</span>
    <span class="n">c</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="k">while</span> <span class="nb">len</span><span class="p">(</span><span class="n">target_samples</span><span class="p">)</span> <span class="o">&lt;</span> <span class="n">n_sample</span><span class="p">:</span>
        <span class="n">c</span> <span class="o">+=</span> <span class="mi">1</span>
        <span class="k">if</span> <span class="n">c</span> <span class="o">&gt;</span> <span class="mf">1e6</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Failed to find </span><span class="si">{</span><span class="n">n_sample</span><span class="si">}</span><span class="s2"> sample points from the target raster.&quot;</span><span class="p">)</span>
        <span class="n">i</span><span class="p">,</span> <span class="n">j</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">choice</span><span class="p">(</span><span class="n">bar_target</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]),</span> <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">choice</span><span class="p">(</span><span class="n">bar_target</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>
        <span class="k">if</span> <span class="n">bar_target</span><span class="p">[</span><span class="n">i</span><span class="p">,</span> <span class="n">j</span><span class="p">]</span> <span class="o">==</span> <span class="n">nodata_value</span><span class="p">:</span>
            <span class="k">continue</span>
        <span class="n">x</span><span class="p">,</span> <span class="n">y</span> <span class="o">=</span> <span class="n">index_to_xy</span><span class="p">(</span><span class="n">i</span><span class="p">,</span> <span class="n">j</span><span class="p">,</span> <span class="n">ds_target</span><span class="o">.</span><span class="n">GetGeoTransform</span><span class="p">())</span>
        <span class="n">target_samples</span><span class="o">.</span><span class="n">append</span><span class="p">([</span><span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">,</span> <span class="n">bar_target</span><span class="p">[</span><span class="n">i</span><span class="p">,</span> <span class="n">j</span><span class="p">]])</span>
        <span class="n">source_i</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">bar_source</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">*</span> <span class="n">i</span> <span class="o">/</span> <span class="n">bar_target</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
        <span class="n">source_j</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">bar_source</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">*</span> <span class="n">j</span> <span class="o">/</span> <span class="n">bar_target</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>
        <span class="n">source_x</span><span class="p">,</span> <span class="n">source_y</span> <span class="o">=</span> <span class="n">index_to_xy</span><span class="p">(</span><span class="n">source_i</span><span class="p">,</span> <span class="n">source_j</span><span class="p">,</span> <span class="n">ds_source</span><span class="o">.</span><span class="n">GetGeoTransform</span><span class="p">())</span>
        <span class="n">source_samples</span><span class="o">.</span><span class="n">append</span><span class="p">([</span><span class="n">source_x</span><span class="p">,</span> <span class="n">source_y</span><span class="p">,</span> <span class="n">bar_source</span><span class="p">[</span><span class="n">source_i</span><span class="p">,</span> <span class="n">source_j</span><span class="p">]])</span>
    <span class="n">ds_source</span><span class="p">,</span> <span class="n">ds_target</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> <span class="kc">None</span>
    <span class="k">if</span> <span class="n">pivot_h_crs</span><span class="p">:</span>
        <span class="n">source_crs_h</span><span class="p">,</span> <span class="n">_</span> <span class="o">=</span> <span class="n">wkt_to_crs</span><span class="p">(</span><span class="n">source_meta</span><span class="p">[</span><span class="s2">&quot;wkt&quot;</span><span class="p">])</span>
        <span class="n">target_crs_h</span><span class="p">,</span> <span class="n">_</span> <span class="o">=</span> <span class="n">wkt_to_crs</span><span class="p">(</span><span class="n">target_meta</span><span class="p">[</span><span class="s2">&quot;wkt&quot;</span><span class="p">])</span>
        <span class="n">source_transformer</span> <span class="o">=</span> <span class="n">pp</span><span class="o">.</span><span class="n">Transformer</span><span class="o">.</span><span class="n">from_crs</span><span class="p">(</span><span class="n">pp</span><span class="o">.</span><span class="n">CRS</span><span class="p">(</span><span class="n">source_crs_h</span><span class="p">),</span>
                                                     <span class="n">pp</span><span class="o">.</span><span class="n">CRS</span><span class="p">(</span><span class="n">pivot_h_crs</span><span class="p">),</span>
                                                     <span class="n">always_xy</span><span class="o">=</span><span class="kc">True</span>
                                                     <span class="p">)</span>
        <span class="n">target_transformer</span> <span class="o">=</span> <span class="n">pp</span><span class="o">.</span><span class="n">Transformer</span><span class="o">.</span><span class="n">from_crs</span><span class="p">(</span><span class="n">pp</span><span class="o">.</span><span class="n">CRS</span><span class="p">(</span><span class="n">target_crs_h</span><span class="p">),</span>
                                                     <span class="n">pp</span><span class="o">.</span><span class="n">CRS</span><span class="p">(</span><span class="n">pivot_h_crs</span><span class="p">),</span>
                                                     <span class="n">always_xy</span><span class="o">=</span><span class="kc">True</span>
                                                     <span class="p">)</span>
        <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">p</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">source_samples</span><span class="p">):</span>
            <span class="n">lon</span><span class="p">,</span> <span class="n">lat</span> <span class="o">=</span> <span class="n">source_transformer</span><span class="o">.</span><span class="n">transform</span><span class="p">(</span><span class="n">p</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">p</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>
            <span class="n">p</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">p</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">lon</span><span class="p">,</span> <span class="n">lat</span>
            <span class="n">lon</span><span class="p">,</span> <span class="n">lat</span> <span class="o">=</span> <span class="n">target_transformer</span><span class="o">.</span><span class="n">transform</span><span class="p">(</span><span class="n">target_samples</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="mi">0</span><span class="p">],</span> <span class="n">target_samples</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="mi">1</span><span class="p">])</span>
            <span class="n">target_samples</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="mi">0</span><span class="p">],</span> <span class="n">target_samples</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">lon</span><span class="p">,</span> <span class="n">lat</span>
    <span class="k">return</span> <span class="n">source_samples</span><span class="p">,</span> <span class="n">target_samples</span></div>



<div class="viewcode-block" id="vdatum_cross_validate_raster">
<a class="viewcode-back" href="../../../vyperdatum.utils.html#vyperdatum.utils.vdatum_rest_utils.vdatum_cross_validate_raster">[docs]</a>
<span class="k">def</span> <span class="nf">vdatum_cross_validate_raster</span><span class="p">(</span><span class="n">s_file</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
                                 <span class="n">t_file</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
                                 <span class="n">n_sample</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span>
                                 <span class="n">tolerance</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mf">0.3</span><span class="p">,</span>
                                 <span class="n">sampling_band</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,</span>
                                 <span class="n">region</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
                                 <span class="n">pivot_h_crs</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
                                 <span class="n">s_h_frame</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
                                 <span class="n">s_v_frame</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
                                 <span class="n">s_h_zone</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
                                 <span class="n">t_h_frame</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
                                 <span class="n">t_v_frame</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
                                 <span class="n">t_h_zone</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span>
                                 <span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Randomly sample the source raster points and transform them to the</span>
<span class="sd">    target CRS using the vdatum API. Verify if the transformed values are</span>
<span class="sd">    consistent with the target raster values.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    s_file: str</span>
<span class="sd">        Absolute path to the source raster file.</span>
<span class="sd">    t_file: str</span>
<span class="sd">        Absolute path to the target (transferred) raster file.</span>
<span class="sd">    n_sample: int</span>
<span class="sd">        The number of sample points (coordinates).</span>
<span class="sd">    sampling_band: dict</span>
<span class="sd">        The index of the source band to be sampled (default 1).</span>
<span class="sd">    region: Optional[str]</span>
<span class="sd">        Vdatum region name (e.g. ak, as, contiguous, gcnmi, prvi)</span>
<span class="sd">        https://vdatum.noaa.gov/docs/services.html#step140</span>
<span class="sd">    pivot_h_crs: Optional[str]</span>
<span class="sd">        When not None, both source and target samples are transformed</span>
<span class="sd">        into a common horizontal CRS, otherwise ignored (default None).</span>
<span class="sd">        Example: pivot_h_crs = &#39;EPSG:6318&#39;</span>
<span class="sd">    s_h_frame: Optional[str]</span>
<span class="sd">        Source horizontal reference frame (e.g. NAD83_2011)</span>
<span class="sd">        https://vdatum.noaa.gov/docs/services.html#step150</span>
<span class="sd">    s_v_frame: Optional[str]</span>
<span class="sd">        source vertical reference frame (e.g. NAVD88, PRVD02, MLLW)</span>
<span class="sd">        https://vdatum.noaa.gov/docs/services.html#step160</span>
<span class="sd">    s_h_zone: Optional[str]</span>
<span class="sd">        source CRS zone, if projected.</span>
<span class="sd">        The details of this parameter is not documented in vdatum services page.</span>
<span class="sd">    t_h_frame: Optional[str]</span>
<span class="sd">        Target horizontal reference frame (e.g. NAD83_2011)</span>
<span class="sd">        https://vdatum.noaa.gov/docs/services.html#step150</span>
<span class="sd">    t_v_frame: Optional[str]</span>
<span class="sd">        Target vertical reference frame (e.g. NAVD88, PRVD02, MLLW)</span>
<span class="sd">        https://vdatum.noaa.gov/docs/services.html#step160</span>
<span class="sd">    t_h_zone: Optional[str]</span>
<span class="sd">        Target CRS zone, if projected.</span>
<span class="sd">        The details of this parameter is not documented in vdatum services page.</span>

<span class="sd">    Returns</span>
<span class="sd">    ----------</span>
<span class="sd">    bool</span>
<span class="sd">        True if all checks pass, otherwise False.</span>
<span class="sd">    pandas.DataFrame</span>
<span class="sd">        Dataframe containing the sampled input, transferred, and vdatum points.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">source_meta</span> <span class="o">=</span> <span class="n">raster_metadata</span><span class="p">(</span><span class="n">s_file</span><span class="p">)</span>
    <span class="n">target_meta</span> <span class="o">=</span> <span class="n">raster_metadata</span><span class="p">(</span><span class="n">t_file</span><span class="p">)</span>
    <span class="n">passed</span> <span class="o">=</span> <span class="kc">True</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">region</span><span class="p">:</span>
        <span class="n">region</span> <span class="o">=</span> <span class="s2">&quot;contiguous&quot;</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">source_meta</span><span class="p">[</span><span class="s2">&quot;overlapping_regions&quot;</span><span class="p">])</span> <span class="o">!=</span> <span class="mi">1</span><span class="p">:</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="s2">&quot;&gt;&gt;&gt;&gt;&gt; Warning &lt;&lt;&lt;&lt;&lt; The input is not overlapping with a single region.&quot;</span>
                           <span class="sa">f</span><span class="s2">&quot; The overlapping regions: (</span><span class="si">{</span><span class="n">source_meta</span><span class="p">[</span><span class="s1">&#39;overlapping_regions&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2">).&quot;</span>
                           <span class="s2">&quot; The Vdatum API region will be set to &#39;contiguous&#39;.&quot;</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">region</span> <span class="o">=</span> <span class="n">api_region_alias</span><span class="p">(</span><span class="n">source_meta</span><span class="p">[</span><span class="s2">&quot;overlapping_regions&quot;</span><span class="p">][</span><span class="mi">0</span><span class="p">])</span>

    <span class="n">source_crs_h</span><span class="p">,</span> <span class="n">source_crs_v</span> <span class="o">=</span> <span class="n">wkt_to_crs</span><span class="p">(</span><span class="n">source_meta</span><span class="p">[</span><span class="s2">&quot;wkt&quot;</span><span class="p">])</span>
    <span class="n">source_zone_h</span> <span class="o">=</span> <span class="n">wkt_to_utm</span><span class="p">(</span><span class="n">source_meta</span><span class="p">[</span><span class="s2">&quot;wkt&quot;</span><span class="p">])</span>
    <span class="n">target_crs_h</span><span class="p">,</span> <span class="n">target_crs_v</span> <span class="o">=</span> <span class="n">wkt_to_crs</span><span class="p">(</span><span class="n">target_meta</span><span class="p">[</span><span class="s2">&quot;wkt&quot;</span><span class="p">])</span>
    <span class="n">target_zone_h</span> <span class="o">=</span> <span class="n">wkt_to_utm</span><span class="p">(</span><span class="n">target_meta</span><span class="p">[</span><span class="s2">&quot;wkt&quot;</span><span class="p">])</span>

    <span class="n">api_src_crs_h</span><span class="p">,</span> <span class="n">api_src_crs_v</span> <span class="o">=</span> <span class="n">api_crs_aliases</span><span class="p">(</span><span class="n">source_meta</span><span class="p">[</span><span class="s2">&quot;wkt&quot;</span><span class="p">])</span>
    <span class="n">source_crs_h</span> <span class="o">=</span> <span class="n">s_h_frame</span> <span class="k">if</span> <span class="n">s_h_frame</span> <span class="k">else</span> <span class="n">api_src_crs_h</span>
    <span class="n">source_crs_v</span> <span class="o">=</span> <span class="n">s_v_frame</span> <span class="k">if</span> <span class="n">s_v_frame</span> <span class="k">else</span> <span class="n">api_src_crs_v</span>
    <span class="n">api_tgt_crs_h</span><span class="p">,</span> <span class="n">api_tgt_crs_v</span> <span class="o">=</span> <span class="n">api_crs_aliases</span><span class="p">(</span><span class="n">target_meta</span><span class="p">[</span><span class="s2">&quot;wkt&quot;</span><span class="p">])</span>
    <span class="n">target_crs_h</span> <span class="o">=</span> <span class="n">t_h_frame</span> <span class="k">if</span> <span class="n">t_h_frame</span> <span class="k">else</span> <span class="n">api_tgt_crs_h</span>
    <span class="n">target_crs_v</span> <span class="o">=</span> <span class="n">t_v_frame</span> <span class="k">if</span> <span class="n">t_v_frame</span> <span class="k">else</span> <span class="n">api_tgt_crs_v</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Taking </span><span class="si">{</span><span class="n">n_sample</span><span class="si">}</span><span class="s2"> random sample</span><span class="si">{</span><span class="s1">&#39;s&#39;</span><span class="w"> </span><span class="k">if</span><span class="w"> </span><span class="n">n_sample</span><span class="w"> </span><span class="o">&gt;</span><span class="w"> </span><span class="mi">1</span><span class="w"> </span><span class="k">else</span><span class="w"> </span><span class="s1">&#39;&#39;</span><span class="si">}</span><span class="s2"> &quot;</span>
          <span class="s2">&quot;from the source and transformed rasters ...&quot;</span><span class="p">)</span>
    <span class="n">source_samples</span><span class="p">,</span> <span class="n">target_samples</span> <span class="o">=</span> <span class="n">sample_raster</span><span class="p">(</span><span class="n">source_meta</span><span class="p">,</span> <span class="n">target_meta</span><span class="p">,</span>
                                                   <span class="n">n_sample</span><span class="p">,</span> <span class="n">sampling_band</span><span class="p">,</span>
                                                   <span class="n">pivot_h_crs</span><span class="o">=</span><span class="n">pivot_h_crs</span><span class="p">)</span>
    <span class="n">vdatum_points</span><span class="p">,</span> <span class="n">vdatum_resp</span> <span class="o">=</span> <span class="p">[],</span> <span class="p">[]</span>
    <span class="n">cross_df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">({})</span>
    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Calling Vdatum API ...&quot;</span><span class="p">)</span>
    <span class="k">for</span> <span class="n">p</span> <span class="ow">in</span> <span class="n">tqdm</span><span class="p">(</span><span class="n">source_samples</span><span class="p">):</span>
        <span class="n">s_h_zone</span> <span class="o">=</span> <span class="n">s_h_zone</span> <span class="k">if</span> <span class="n">s_h_zone</span> <span class="k">else</span> <span class="n">source_zone_h</span>
        <span class="n">t_h_zone</span> <span class="o">=</span> <span class="n">t_h_zone</span> <span class="k">if</span> <span class="n">t_h_zone</span> <span class="k">else</span> <span class="n">target_zone_h</span>
        <span class="k">if</span> <span class="n">pivot_h_crs</span><span class="p">:</span>
            <span class="n">s_h_zone</span><span class="p">,</span> <span class="n">t_h_zone</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> <span class="kc">None</span>
        <span class="n">points</span><span class="p">,</span> <span class="n">resp</span> <span class="o">=</span> <span class="n">vdatum_transform_point</span><span class="p">(</span><span class="n">s_x</span><span class="o">=</span><span class="n">p</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">s_y</span><span class="o">=</span><span class="n">p</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">s_z</span><span class="o">=</span><span class="n">p</span><span class="p">[</span><span class="mi">2</span><span class="p">],</span>
                                              <span class="n">region</span><span class="o">=</span><span class="n">region</span><span class="p">,</span>
                                              <span class="n">s_h_frame</span><span class="o">=</span><span class="n">s_h_frame</span> <span class="ow">or</span> <span class="n">source_crs_h</span><span class="p">,</span>
                                              <span class="n">s_v_frame</span><span class="o">=</span><span class="n">s_v_frame</span> <span class="ow">or</span> <span class="n">source_crs_v</span><span class="p">,</span>
                                              <span class="n">s_h_zone</span><span class="o">=</span><span class="n">s_h_zone</span><span class="p">,</span>
                                              <span class="n">t_h_frame</span><span class="o">=</span><span class="n">t_h_frame</span> <span class="ow">or</span> <span class="n">target_crs_h</span><span class="p">,</span>
                                              <span class="n">t_v_frame</span><span class="o">=</span><span class="n">t_v_frame</span> <span class="ow">or</span> <span class="n">target_crs_v</span><span class="p">,</span>
                                              <span class="n">t_h_zone</span><span class="o">=</span><span class="n">t_h_zone</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">points</span><span class="p">:</span>
            <span class="n">vdatum_points</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">points</span><span class="p">)</span>
            <span class="n">vdatum_resp</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">resp</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">vdatum_points</span><span class="o">.</span><span class="n">append</span><span class="p">((</span><span class="kc">None</span><span class="p">,</span> <span class="kc">None</span><span class="p">,</span> <span class="kc">None</span><span class="p">))</span>
            <span class="n">vdatum_resp</span><span class="o">.</span><span class="n">append</span><span class="p">({})</span>
    <span class="n">cross_df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">({</span><span class="s2">&quot;src_x&quot;</span><span class="p">:</span> <span class="p">[</span><span class="n">p</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="k">for</span> <span class="n">p</span> <span class="ow">in</span> <span class="n">source_samples</span><span class="p">],</span>
                             <span class="s2">&quot;src_y&quot;</span><span class="p">:</span> <span class="p">[</span><span class="n">p</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="k">for</span> <span class="n">p</span> <span class="ow">in</span> <span class="n">source_samples</span><span class="p">],</span>
                             <span class="s2">&quot;src_val&quot;</span><span class="p">:</span> <span class="p">[</span><span class="n">p</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="k">for</span> <span class="n">p</span> <span class="ow">in</span> <span class="n">source_samples</span><span class="p">],</span>
                             <span class="s2">&quot;tgt_x&quot;</span><span class="p">:</span> <span class="p">[</span><span class="n">p</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="k">for</span> <span class="n">p</span> <span class="ow">in</span> <span class="n">target_samples</span><span class="p">],</span>
                             <span class="s2">&quot;tgt_y&quot;</span><span class="p">:</span> <span class="p">[</span><span class="n">p</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="k">for</span> <span class="n">p</span> <span class="ow">in</span> <span class="n">target_samples</span><span class="p">],</span>
                             <span class="s2">&quot;tgt_val&quot;</span><span class="p">:</span> <span class="p">[</span><span class="n">p</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="k">for</span> <span class="n">p</span> <span class="ow">in</span> <span class="n">target_samples</span><span class="p">],</span>
                             <span class="s2">&quot;vdatum_x&quot;</span><span class="p">:</span> <span class="p">[</span><span class="n">p</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="k">for</span> <span class="n">p</span> <span class="ow">in</span> <span class="n">vdatum_points</span><span class="p">],</span>
                             <span class="s2">&quot;vdatum_y&quot;</span><span class="p">:</span> <span class="p">[</span><span class="n">p</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="k">for</span> <span class="n">p</span> <span class="ow">in</span> <span class="n">vdatum_points</span><span class="p">],</span>
                             <span class="s2">&quot;vdatum_val&quot;</span><span class="p">:</span> <span class="p">[</span><span class="n">p</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="k">for</span> <span class="n">p</span> <span class="ow">in</span> <span class="n">vdatum_points</span><span class="p">],</span>
                             <span class="s2">&quot;vdatum_resp&quot;</span><span class="p">:</span> <span class="p">[</span><span class="nb">str</span><span class="p">(</span><span class="n">r</span><span class="p">)</span> <span class="k">for</span> <span class="n">r</span> <span class="ow">in</span> <span class="n">vdatum_resp</span><span class="p">],</span>
                             <span class="p">})</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="c1"># remove vdatum outlier/erroneous responses</span>
        <span class="n">cross_df</span> <span class="o">=</span> <span class="n">cross_df</span><span class="o">.</span><span class="n">query</span><span class="p">(</span><span class="s2">&quot;abs(vdatum_val)&lt;10000&quot;</span><span class="p">)</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">cross_df</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">passed</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="n">cross_df</span> <span class="o">=</span> <span class="n">cross_df</span><span class="o">.</span><span class="n">assign</span><span class="p">(</span><span class="n">deviation</span><span class="o">=</span><span class="n">cross_df</span><span class="p">[</span><span class="s2">&quot;tgt_val&quot;</span><span class="p">]</span> <span class="o">-</span> <span class="n">cross_df</span><span class="p">[</span><span class="s2">&quot;vdatum_val&quot;</span><span class="p">])</span>
        <span class="n">deviation</span> <span class="o">=</span> <span class="n">cross_df</span><span class="p">[</span><span class="s2">&quot;deviation&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">abs</span><span class="p">()</span><span class="o">.</span><span class="n">mean</span><span class="p">()</span>
        <span class="k">if</span> <span class="n">deviation</span> <span class="o">&gt;</span> <span class="n">tolerance</span><span class="p">:</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">Fore</span><span class="o">.</span><span class="n">RED</span><span class="si">}</span><span class="s2">The deviation between the transferred values produced by &quot;</span>
                           <span class="sa">f</span><span class="s2">&quot;Vyperdatum and Vdatum is </span><span class="si">{</span><span class="n">deviation</span><span class="si">:</span><span class="s2">.2f</span><span class="si">}</span><span class="s2"> exceeding&quot;</span>
                           <span class="sa">f</span><span class="s2">&quot; the threshold </span><span class="si">{</span><span class="n">tolerance</span><span class="si">}</span><span class="s2">.&quot;</span><span class="p">)</span>
            <span class="n">passed</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">Fore</span><span class="o">.</span><span class="n">GREEN</span><span class="si">}</span><span class="s2">The deviation between the transferred values produced by &quot;</span>
                           <span class="sa">f</span><span class="s2">&quot;Vyperdatum and Vdatum is </span><span class="si">{</span><span class="n">deviation</span><span class="si">:</span><span class="s2">.2f</span><span class="si">}</span><span class="s2">, below&quot;</span>
                           <span class="sa">f</span><span class="s2">&quot; the threshold </span><span class="si">{</span><span class="n">tolerance</span><span class="si">}</span><span class="s2">.&quot;</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="n">Style</span><span class="o">.</span><span class="n">RESET_ALL</span><span class="p">)</span>
    <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">exception</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Exception in Vdatum deviation calculation:</span><span class="se">\n</span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="n">passed</span><span class="p">,</span> <span class="n">cross_df</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">({})</span>
    <span class="k">return</span> <span class="n">passed</span><span class="p">,</span> <span class="n">cross_df</span></div>

</pre></div>

           </div>
          </div>
          <footer>

  <hr/>

  <div role="contentinfo">
    <p>&#169; Copyright 2024, Mohammad Ashkezari.</p>
  </div>

  Built with <a href="https://www.sphinx-doc.org/">Sphinx</a> using a
    <a href="https://github.com/readthedocs/sphinx_rtd_theme">theme</a>
    provided by <a href="https://readthedocs.org">Read the Docs</a>.
   

</footer>
        </div>
      </div>
    </section>
  </div>
  <script>
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script> 

</body>
</html>