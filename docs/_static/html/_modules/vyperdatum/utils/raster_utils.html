<!DOCTYPE html>
<html class="writer-html5" lang="en" data-content_root="../../../">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>vyperdatum.utils.raster_utils &mdash; Vyperdatum 0.1.1 documentation</title>
      <link rel="stylesheet" type="text/css" href="../../../_static/pygments.css?v=80d5e7a1" />
      <link rel="stylesheet" type="text/css" href="../../../_static/css/theme.css?v=19f00094" />

  
  <!--[if lt IE 9]>
    <script src="../../../_static/js/html5shiv.min.js"></script>
  <![endif]-->
  
        <script src="../../../_static/jquery.js?v=5d32c60e"></script>
        <script src="../../../_static/_sphinx_javascript_frameworks_compat.js?v=2cd50e6c"></script>
        <script src="../../../_static/documentation_options.js?v=a58bc63e"></script>
        <script src="../../../_static/doctools.js?v=9a2dae69"></script>
        <script src="../../../_static/sphinx_highlight.js?v=dc90522c"></script>
    <script src="../../../_static/js/theme.js"></script>
    <link rel="index" title="Index" href="../../../genindex.html" />
    <link rel="search" title="Search" href="../../../search.html" /> 
</head>

<body class="wy-body-for-nav"> 
  <div class="wy-grid-for-nav">
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search" >

          
          
          <a href="../../../index.html" class="icon icon-home">
            Vyperdatum
          </a>
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../../../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" aria-label="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>
        </div><div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="Navigation menu">
              <p class="caption" role="heading"><span class="caption-text">Contents:</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../../modules.html">vyperdatum</a></li>
</ul>

        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap"><nav class="wy-nav-top" aria-label="Mobile navigation menu" >
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../../../index.html">Vyperdatum</a>
      </nav>

      <div class="wy-nav-content">
        <div class="rst-content">
          <div role="navigation" aria-label="Page navigation">
  <ul class="wy-breadcrumbs">
      <li><a href="../../../index.html" class="icon icon-home" aria-label="Home"></a></li>
          <li class="breadcrumb-item"><a href="../../index.html">Module code</a></li>
      <li class="breadcrumb-item active">vyperdatum.utils.raster_utils</li>
      <li class="wy-breadcrumbs-aside">
      </li>
  </ul>
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
             
  <h1>Source code for vyperdatum.utils.raster_utils</h1><div class="highlight"><pre>
<span></span><span class="kn">import</span> <span class="nn">os</span>
<span class="kn">import</span> <span class="nn">pathlib</span>
<span class="kn">import</span> <span class="nn">logging</span>
<span class="kn">from</span> <span class="nn">osgeo</span> <span class="kn">import</span> <span class="n">gdal</span>
<span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>
<span class="kn">from</span> <span class="nn">typing</span> <span class="kn">import</span> <span class="n">Union</span><span class="p">,</span> <span class="n">Optional</span>
<span class="kn">import</span> <span class="nn">pyproj</span> <span class="k">as</span> <span class="nn">pp</span>
<span class="kn">from</span> <span class="nn">.spatial_utils</span> <span class="kn">import</span> <span class="n">overlapping_regions</span><span class="p">,</span> <span class="n">overlapping_extents</span>
<span class="kn">from</span> <span class="nn">vyperdatum.enums</span> <span class="kn">import</span> <span class="n">VDATUM</span>


<span class="n">logger</span> <span class="o">=</span> <span class="n">logging</span><span class="o">.</span><span class="n">getLogger</span><span class="p">(</span><span class="s2">&quot;root_logger&quot;</span><span class="p">)</span>
<span class="n">gdal</span><span class="o">.</span><span class="n">UseExceptions</span><span class="p">()</span>


<div class="viewcode-block" id="band_stats">
<a class="viewcode-back" href="../../../vyperdatum.utils.html#vyperdatum.utils.raster_utils.band_stats">[docs]</a>
<span class="k">def</span> <span class="nf">band_stats</span><span class="p">(</span><span class="n">band_array</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">list</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Return a list containing the min, max, mean, and std of the band array.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    band_array: numpy.ndarray</span>
<span class="sd">        raster band array</span>

<span class="sd">    Returns:</span>
<span class="sd">    --------</span>
<span class="sd">    list:</span>
<span class="sd">        min, max, mean, and std of the band array.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">return</span> <span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">nanmin</span><span class="p">(</span><span class="n">band_array</span><span class="p">),</span> <span class="n">np</span><span class="o">.</span><span class="n">nanmax</span><span class="p">(</span><span class="n">band_array</span><span class="p">),</span>
            <span class="n">np</span><span class="o">.</span><span class="n">nanmean</span><span class="p">(</span><span class="n">band_array</span><span class="p">),</span> <span class="n">np</span><span class="o">.</span><span class="n">nanstd</span><span class="p">(</span><span class="n">band_array</span><span class="p">)]</span></div>



<div class="viewcode-block" id="raster_metadata">
<a class="viewcode-back" href="../../../vyperdatum.utils.html#vyperdatum.utils.raster_utils.raster_metadata">[docs]</a>
<span class="k">def</span> <span class="nf">raster_metadata</span><span class="p">(</span><span class="n">raster_file</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">verbose</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">dict</span><span class="p">:</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="n">metadata</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="n">ds</span> <span class="o">=</span> <span class="n">gdal</span><span class="o">.</span><span class="n">Open</span><span class="p">(</span><span class="n">raster_file</span><span class="p">,</span> <span class="n">gdal</span><span class="o">.</span><span class="n">GA_ReadOnly</span><span class="p">)</span>
        <span class="n">srs</span> <span class="o">=</span> <span class="n">ds</span><span class="o">.</span><span class="n">GetSpatialRef</span><span class="p">()</span>
        <span class="n">gdal_metadata</span> <span class="o">=</span> <span class="n">ds</span><span class="o">.</span><span class="n">GetMetadata</span><span class="p">()</span>
        <span class="n">metadata</span> <span class="o">|=</span> <span class="p">{</span><span class="s2">&quot;path&quot;</span><span class="p">:</span> <span class="n">raster_file</span><span class="p">}</span>
        <span class="n">metadata</span> <span class="o">|=</span> <span class="p">{</span><span class="s2">&quot;description&quot;</span><span class="p">:</span> <span class="n">ds</span><span class="o">.</span><span class="n">GetDescription</span><span class="p">()}</span>
        <span class="n">metadata</span> <span class="o">|=</span> <span class="p">{</span><span class="s2">&quot;driver&quot;</span><span class="p">:</span> <span class="n">ds</span><span class="o">.</span><span class="n">GetDriver</span><span class="p">()</span><span class="o">.</span><span class="n">ShortName</span><span class="p">}</span>
        <span class="n">metadata</span> <span class="o">|=</span> <span class="p">{</span><span class="s2">&quot;bands&quot;</span><span class="p">:</span> <span class="n">ds</span><span class="o">.</span><span class="n">RasterCount</span><span class="p">}</span>
        <span class="n">metadata</span> <span class="o">|=</span> <span class="p">{</span><span class="s2">&quot;dimensions&quot;</span><span class="p">:</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">ds</span><span class="o">.</span><span class="n">RasterXSize</span><span class="si">}</span><span class="s2"> x </span><span class="si">{</span><span class="n">ds</span><span class="o">.</span><span class="n">RasterYSize</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">}</span>
        <span class="n">metadata</span> <span class="o">|=</span> <span class="p">{</span><span class="s2">&quot;band_no_data&quot;</span><span class="p">:</span> <span class="p">[</span><span class="n">ds</span><span class="o">.</span><span class="n">GetRasterBand</span><span class="p">(</span><span class="n">i</span><span class="o">+</span><span class="mi">1</span><span class="p">)</span><span class="o">.</span><span class="n">GetNoDataValue</span><span class="p">()</span>
                                      <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">ds</span><span class="o">.</span><span class="n">RasterCount</span><span class="p">)]}</span>
        <span class="n">metadata</span> <span class="o">|=</span> <span class="p">{</span><span class="s2">&quot;band_descriptions&quot;</span><span class="p">:</span> <span class="p">[</span><span class="n">ds</span><span class="o">.</span><span class="n">GetRasterBand</span><span class="p">(</span><span class="n">i</span><span class="o">+</span><span class="mi">1</span><span class="p">)</span><span class="o">.</span><span class="n">GetDescription</span><span class="p">()</span>
                                           <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">ds</span><span class="o">.</span><span class="n">RasterCount</span><span class="p">)]}</span>
        <span class="c1"># metadata |= {&quot;band_stats&quot;: [band_stats(ds.GetRasterBand(i+1).ReadAsArray())</span>
        <span class="c1">#                             for i in range(ds.RasterCount)]}</span>
        <span class="n">metadata</span> <span class="o">|=</span> <span class="p">{</span><span class="s2">&quot;compression&quot;</span><span class="p">:</span> <span class="n">ds</span><span class="o">.</span><span class="n">GetMetadata</span><span class="p">(</span><span class="s2">&quot;IMAGE_STRUCTURE&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;COMPRESSION&quot;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)}</span>
        <span class="n">metadata</span> <span class="o">|=</span> <span class="p">{</span><span class="s2">&quot;vertical_datum_wkt&quot;</span><span class="p">:</span> <span class="n">gdal_metadata</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;VERTICALDATUMWKT&quot;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)}</span> <span class="c1">#Input Vertical Datum WKT (Xipe)</span>
        <span class="n">metadata</span> <span class="o">|=</span> <span class="p">{</span><span class="s2">&quot;coordinate_epoch&quot;</span><span class="p">:</span> <span class="n">srs</span><span class="o">.</span><span class="n">GetCoordinateEpoch</span><span class="p">()}</span>
        <span class="n">geot</span> <span class="o">=</span> <span class="n">ds</span><span class="o">.</span><span class="n">GetGeoTransform</span><span class="p">()</span>
        <span class="n">res_x</span><span class="p">,</span> <span class="n">res_y</span> <span class="o">=</span> <span class="n">geot</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">geot</span><span class="p">[</span><span class="mi">5</span><span class="p">]</span>
        <span class="n">x_min</span><span class="p">,</span> <span class="n">y_max</span> <span class="o">=</span> <span class="n">geot</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">geot</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span>
        <span class="n">x_max</span> <span class="o">=</span> <span class="n">x_min</span> <span class="o">+</span> <span class="n">res_x</span> <span class="o">*</span> <span class="n">ds</span><span class="o">.</span><span class="n">RasterXSize</span>
        <span class="n">y_min</span> <span class="o">=</span> <span class="n">y_max</span> <span class="o">+</span> <span class="n">res_y</span> <span class="o">*</span> <span class="n">ds</span><span class="o">.</span><span class="n">RasterYSize</span>
        <span class="n">metadata</span> <span class="o">|=</span> <span class="p">{</span><span class="s2">&quot;geo_transform&quot;</span><span class="p">:</span> <span class="n">geot</span><span class="p">}</span>
        <span class="n">metadata</span> <span class="o">|=</span> <span class="p">{</span><span class="s2">&quot;extent&quot;</span><span class="p">:</span> <span class="p">[</span><span class="n">x_min</span><span class="p">,</span> <span class="n">y_min</span><span class="p">,</span> <span class="n">x_max</span><span class="p">,</span> <span class="n">y_max</span><span class="p">]}</span>
        <span class="n">metadata</span> <span class="o">|=</span> <span class="p">{</span><span class="s2">&quot;resolution&quot;</span><span class="p">:</span> <span class="p">[</span><span class="n">res_x</span><span class="p">,</span> <span class="n">res_y</span><span class="p">]}</span>
        <span class="n">metadata</span> <span class="o">|=</span> <span class="p">{</span><span class="s2">&quot;wkt&quot;</span><span class="p">:</span> <span class="n">srs</span><span class="o">.</span><span class="n">ExportToWkt</span><span class="p">()}</span>
        <span class="n">ds</span> <span class="o">=</span> <span class="kc">None</span>

        <span class="n">input_crs</span> <span class="o">=</span> <span class="n">pp</span><span class="o">.</span><span class="n">CRS</span><span class="p">(</span><span class="n">metadata</span><span class="p">[</span><span class="s2">&quot;wkt&quot;</span><span class="p">])</span>
        <span class="k">if</span> <span class="n">input_crs</span><span class="o">.</span><span class="n">is_compound</span><span class="p">:</span>
            <span class="n">input_horizontal_crs</span> <span class="o">=</span> <span class="n">pp</span><span class="o">.</span><span class="n">CRS</span><span class="p">(</span><span class="n">input_crs</span><span class="o">.</span><span class="n">sub_crs_list</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
            <span class="n">input_vertical_crs</span> <span class="o">=</span> <span class="n">pp</span><span class="o">.</span><span class="n">CRS</span><span class="p">(</span><span class="n">input_crs</span><span class="o">.</span><span class="n">sub_crs_list</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">input_horizontal_crs</span> <span class="o">=</span> <span class="n">input_crs</span>
            <span class="n">input_vertical_crs</span> <span class="o">=</span> <span class="kc">None</span>

        <span class="n">transformer</span> <span class="o">=</span> <span class="n">pp</span><span class="o">.</span><span class="n">Transformer</span><span class="o">.</span><span class="n">from_crs</span><span class="p">(</span><span class="n">input_horizontal_crs</span><span class="p">,</span>
                                              <span class="s2">&quot;EPSG:6318&quot;</span><span class="p">,</span>
                                              <span class="n">always_xy</span><span class="o">=</span><span class="kc">True</span>
                                              <span class="p">)</span>
        <span class="p">[[</span><span class="n">lon_min</span><span class="p">,</span> <span class="n">lon_max</span><span class="p">],</span> <span class="p">[</span><span class="n">lat_min</span><span class="p">,</span> <span class="n">lat_max</span><span class="p">]]</span> <span class="o">=</span> <span class="n">transformer</span><span class="o">.</span><span class="n">transform</span><span class="p">([</span><span class="n">x_min</span><span class="p">,</span> <span class="n">x_max</span><span class="p">],</span>
                                                                         <span class="p">[</span><span class="n">y_min</span><span class="p">,</span> <span class="n">y_max</span><span class="p">])</span>
        <span class="n">metadata</span> <span class="o">|=</span> <span class="p">{</span><span class="s2">&quot;geo_extent&quot;</span><span class="p">:</span> <span class="p">[</span><span class="n">lon_min</span><span class="p">,</span> <span class="n">lat_min</span><span class="p">,</span> <span class="n">lon_max</span><span class="p">,</span> <span class="n">lat_max</span><span class="p">]}</span>
        <span class="n">metadata</span> <span class="o">|=</span> <span class="p">{</span><span class="s2">&quot;overlapping_regions&quot;</span><span class="p">:</span> <span class="n">overlapping_regions</span><span class="p">(</span><span class="n">VDATUM</span><span class="o">.</span><span class="n">DIR</span><span class="o">.</span><span class="n">value</span><span class="p">,</span> <span class="o">*</span><span class="n">metadata</span><span class="p">[</span><span class="s2">&quot;geo_extent&quot;</span><span class="p">])}</span>
        <span class="n">metadata</span> <span class="o">|=</span> <span class="p">{</span><span class="s2">&quot;overlapping_extents&quot;</span><span class="p">:</span> <span class="n">overlapping_extents</span><span class="p">(</span><span class="o">*</span><span class="n">metadata</span><span class="p">[</span><span class="s2">&quot;geo_extent&quot;</span><span class="p">])}</span>
        <span class="n">metadata</span> <span class="o">|=</span> <span class="p">{</span><span class="s2">&quot;info&quot;</span><span class="p">:</span> <span class="n">gdal</span><span class="o">.</span><span class="n">Info</span><span class="p">(</span><span class="n">raster_file</span><span class="p">,</span> <span class="nb">format</span><span class="o">=</span><span class="s2">&quot;json&quot;</span><span class="p">)}</span>

    <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">exception</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Unable to get raster metadata: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">verbose</span><span class="p">:</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="s1">&#39;-&#39;</span><span class="o">*</span><span class="mi">80</span><span class="si">}</span><span class="se">\n</span><span class="s2">File: </span><span class="si">{</span><span class="n">pathlib</span><span class="o">.</span><span class="n">Path</span><span class="p">(</span><span class="n">raster_file</span><span class="p">)</span><span class="o">.</span><span class="n">name</span><span class="si">}</span><span class="s2">&quot;</span>
              <span class="sa">f</span><span class="s2">&quot;</span><span class="se">\n\t</span><span class="s2">Input CRS: </span><span class="si">{</span><span class="n">input_crs</span><span class="o">.</span><span class="n">name</span><span class="si">}</span><span class="s2">&quot;</span>
              <span class="sa">f</span><span class="s2">&quot;</span><span class="se">\n\t</span><span class="s2">Input Horizontal Authority: </span><span class="si">{</span><span class="n">input_horizontal_crs</span><span class="o">.</span><span class="n">to_authority</span><span class="p">()</span><span class="si">}</span><span class="s2">&quot;</span>
              <span class="sa">f</span><span class="s2">&quot;</span><span class="se">\n\t</span><span class="s2">Input Vertical Authority: </span><span class="si">{</span><span class="n">input_vertical_crs</span><span class="o">.</span><span class="n">to_authority</span><span class="p">()</span><span class="w"> </span><span class="k">if</span><span class="w"> </span><span class="n">input_crs</span><span class="o">.</span><span class="n">is_compound</span><span class="w"> </span><span class="k">else</span><span class="w"> </span><span class="kc">None</span><span class="si">}</span><span class="s2">&quot;</span>
              <span class="sa">f</span><span class="s2">&quot;</span><span class="se">\n\t</span><span class="s2">Input Vertical CRS: </span><span class="si">{</span><span class="n">input_vertical_crs</span><span class="w"> </span><span class="k">if</span><span class="w"> </span><span class="n">input_crs</span><span class="o">.</span><span class="n">is_compound</span><span class="w"> </span><span class="k">else</span><span class="w"> </span><span class="kc">None</span><span class="si">}</span><span class="s2">&quot;</span>
              <span class="sa">f</span><span class="s2">&quot;</span><span class="se">\n\t</span><span class="s2">Input Vertical CRS WKT: </span><span class="si">{</span><span class="n">input_vertical_crs</span><span class="o">.</span><span class="n">to_wkt</span><span class="p">()</span><span class="w"> </span><span class="k">if</span><span class="w"> </span><span class="n">input_crs</span><span class="o">.</span><span class="n">is_compound</span><span class="w"> </span><span class="k">else</span><span class="w"> </span><span class="kc">None</span><span class="si">}</span><span class="s2">&quot;</span>
              <span class="sa">f</span><span class="s2">&quot;</span><span class="se">\n</span><span class="si">{</span><span class="s1">&#39;-&#39;</span><span class="o">*</span><span class="mi">80</span><span class="si">}</span><span class="se">\n</span><span class="s2">&quot;</span>
              <span class="p">)</span>
    <span class="k">return</span> <span class="n">metadata</span></div>



<div class="viewcode-block" id="add_overview">
<a class="viewcode-back" href="../../../vyperdatum.utils.html#vyperdatum.utils.raster_utils.add_overview">[docs]</a>
<span class="k">def</span> <span class="nf">add_overview</span><span class="p">(</span><span class="n">raster_file</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">compression</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span><span class="p">,</span> <span class="n">embedded</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">True</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Add overview bands to a raster file with no existing overviews.</span>

<span class="sd">    parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    raster_file: str</span>
<span class="sd">        Absolute full path to the raster file.</span>
<span class="sd">    compression: str</span>
<span class="sd">        The name of compression algorithm.</span>
<span class="sd">    embedded: bool, default=True</span>
<span class="sd">        If True, the overviews will be embedded in the file, otherwise stored externally.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="n">ds</span> <span class="o">=</span> <span class="n">gdal</span><span class="o">.</span><span class="n">Open</span><span class="p">(</span><span class="n">raster_file</span><span class="p">,</span> <span class="n">gdal</span><span class="o">.</span><span class="n">GA_Update</span> <span class="k">if</span> <span class="n">embedded</span> <span class="k">else</span> <span class="n">gdal</span><span class="o">.</span><span class="n">GA_ReadOnly</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">compression</span><span class="p">:</span>
            <span class="n">gdal</span><span class="o">.</span><span class="n">SetConfigOption</span><span class="p">(</span><span class="s2">&quot;COMPRESS_OVERVIEW&quot;</span><span class="p">,</span> <span class="n">compression</span><span class="p">)</span>
    <span class="k">finally</span><span class="p">:</span>
        <span class="n">ds</span><span class="o">.</span><span class="n">BuildOverviews</span><span class="p">(</span><span class="s2">&quot;NEAREST&quot;</span><span class="p">,</span> <span class="p">[</span><span class="mi">2</span><span class="p">,</span> <span class="mi">4</span><span class="p">,</span> <span class="mi">16</span><span class="p">],</span> <span class="n">gdal</span><span class="o">.</span><span class="n">TermProgress_nocb</span><span class="p">)</span>
        <span class="n">ds</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="k">return</span></div>



<div class="viewcode-block" id="add_rat">
<a class="viewcode-back" href="../../../vyperdatum.utils.html#vyperdatum.utils.raster_utils.add_rat">[docs]</a>
<span class="k">def</span> <span class="nf">add_rat</span><span class="p">(</span><span class="n">raster</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Add Raster Attribute Table (RAT) to all bands of a raster file.</span>

<span class="sd">    parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    raster_file: str</span>
<span class="sd">        Absolute full path to the raster file.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">ds</span> <span class="o">=</span> <span class="n">gdal</span><span class="o">.</span><span class="n">Open</span><span class="p">(</span><span class="n">raster</span><span class="p">)</span>
    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">ds</span><span class="o">.</span><span class="n">RasterCount</span><span class="p">):</span>
        <span class="n">rat</span> <span class="o">=</span> <span class="n">gdal</span><span class="o">.</span><span class="n">RasterAttributeTable</span><span class="p">()</span>
        <span class="n">rat</span><span class="o">.</span><span class="n">CreateColumn</span><span class="p">(</span><span class="s2">&quot;VALUE&quot;</span><span class="p">,</span> <span class="n">gdal</span><span class="o">.</span><span class="n">GFT_Real</span><span class="p">,</span> <span class="n">gdal</span><span class="o">.</span><span class="n">GFU_Generic</span><span class="p">)</span>
        <span class="n">rat</span><span class="o">.</span><span class="n">CreateColumn</span><span class="p">(</span><span class="s2">&quot;COUNT&quot;</span><span class="p">,</span> <span class="n">gdal</span><span class="o">.</span><span class="n">GFT_Integer</span><span class="p">,</span> <span class="n">gdal</span><span class="o">.</span><span class="n">GFU_Generic</span><span class="p">)</span>
        <span class="n">band</span> <span class="o">=</span> <span class="n">ds</span><span class="o">.</span><span class="n">GetRasterBand</span><span class="p">(</span><span class="n">i</span><span class="o">+</span><span class="mi">1</span><span class="p">)</span>
        <span class="n">unique</span><span class="p">,</span> <span class="n">counts</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">unique</span><span class="p">(</span><span class="n">band</span><span class="o">.</span><span class="n">ReadAsArray</span><span class="p">(),</span> <span class="n">return_counts</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">unique</span><span class="p">)):</span>
            <span class="n">rat</span><span class="o">.</span><span class="n">SetValueAsDouble</span><span class="p">(</span><span class="n">i</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="nb">float</span><span class="p">(</span><span class="n">unique</span><span class="p">[</span><span class="n">i</span><span class="p">]))</span>
            <span class="n">rat</span><span class="o">.</span><span class="n">SetValueAsInt</span><span class="p">(</span><span class="n">i</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="nb">int</span><span class="p">(</span><span class="n">counts</span><span class="p">[</span><span class="n">i</span><span class="p">]))</span>
        <span class="n">band</span><span class="o">.</span><span class="n">SetDefaultRAT</span><span class="p">(</span><span class="n">rat</span><span class="p">)</span>
    <span class="n">ds</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="k">return</span></div>



<div class="viewcode-block" id="set_nodatavalue">
<a class="viewcode-back" href="../../../vyperdatum.utils.html#vyperdatum.utils.raster_utils.set_nodatavalue">[docs]</a>
<span class="k">def</span> <span class="nf">set_nodatavalue</span><span class="p">(</span><span class="n">raster_file</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
                    <span class="n">band_nodatavalue</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span><span class="nb">list</span><span class="p">[</span><span class="nb">tuple</span><span class="p">[</span><span class="nb">int</span><span class="p">,</span> <span class="nb">float</span><span class="p">]],</span> <span class="nb">float</span><span class="p">],</span>
                    <span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Change the NoDataValue of the raster file bands.</span>

<span class="sd">    parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    raster_file: str</span>
<span class="sd">        Absolute full path to the raster file.</span>
<span class="sd">    band_nodatavalue: Union[list[tuple[int, float]], float]</span>
<span class="sd">        A list of tuples: (band_index, NoDataValue).</span>
<span class="sd">        If a single float is passed, all bands will be affected.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">band_nodatavalue</span><span class="p">,</span> <span class="nb">float</span><span class="p">):</span>
        <span class="n">ds</span> <span class="o">=</span> <span class="n">gdal</span><span class="o">.</span><span class="n">Open</span><span class="p">(</span><span class="n">raster_file</span><span class="p">)</span>
        <span class="n">band_nodatavalue</span> <span class="o">=</span> <span class="p">[(</span><span class="n">b</span><span class="p">,</span> <span class="n">band_nodatavalue</span><span class="p">)</span> <span class="k">for</span> <span class="n">b</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">ds</span><span class="o">.</span><span class="n">RasterCount</span><span class="o">+</span><span class="mi">1</span><span class="p">)]</span>
        <span class="n">ds</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="n">ds</span> <span class="o">=</span> <span class="n">gdal</span><span class="o">.</span><span class="n">Open</span><span class="p">(</span><span class="n">raster_file</span><span class="p">,</span> <span class="n">gdal</span><span class="o">.</span><span class="n">GA_Update</span><span class="p">)</span>
    <span class="k">for</span> <span class="n">b</span><span class="p">,</span> <span class="n">nodv</span> <span class="ow">in</span> <span class="n">band_nodatavalue</span><span class="p">:</span>
        <span class="n">band</span> <span class="o">=</span> <span class="n">ds</span><span class="o">.</span><span class="n">GetRasterBand</span><span class="p">(</span><span class="n">b</span><span class="p">)</span>
        <span class="n">bar</span> <span class="o">=</span> <span class="n">band</span><span class="o">.</span><span class="n">ReadAsArray</span><span class="p">()</span>
        <span class="n">bar</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">bar</span> <span class="o">==</span> <span class="n">band</span><span class="o">.</span><span class="n">GetNoDataValue</span><span class="p">())]</span> <span class="o">=</span> <span class="n">nodv</span>
        <span class="n">band</span><span class="o">.</span><span class="n">WriteArray</span><span class="p">(</span><span class="n">bar</span><span class="p">)</span>
        <span class="n">ds</span><span class="o">.</span><span class="n">GetRasterBand</span><span class="p">(</span><span class="n">b</span><span class="p">)</span><span class="o">.</span><span class="n">SetNoDataValue</span><span class="p">(</span><span class="n">nodv</span><span class="p">)</span>
        <span class="n">band</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="n">ds</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="k">return</span></div>



<div class="viewcode-block" id="unchanged_to_nodata">
<a class="viewcode-back" href="../../../vyperdatum.utils.html#vyperdatum.utils.raster_utils.unchanged_to_nodata">[docs]</a>
<span class="k">def</span> <span class="nf">unchanged_to_nodata</span><span class="p">(</span><span class="n">src_raster_file</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
                        <span class="n">xform_raster_file</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
                        <span class="n">xform_band</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span>
                        <span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Compare the `xform_band` values of the `src_raster_file` and `xform_raster_file`.</span>
<span class="sd">    Change the values to NoDataValue if the transformed value is the same as the</span>
<span class="sd">    original value (indicating that the transformation has failed).</span>
<span class="sd">    Currentl, PROJ keep the source raster unchanged when fails to apply the transformation.</span>
<span class="sd">    The transformation fails when the source data is outside any of the underlying</span>
<span class="sd">    transformation grids. This function is meant to replace the failed transformation</span>
<span class="sd">    points with NoDataValue.  </span>

<span class="sd">    parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    src_raster_file: str</span>
<span class="sd">        Absolute full path to the source raster file.</span>
<span class="sd">    xform_raster_file: str</span>
<span class="sd">        Absolute full path to the transformed raster file.</span>
<span class="sd">    xform_band: int</span>
<span class="sd">        The reference band index that is used for comparison between the source and transformed file.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">src_ds</span> <span class="o">=</span> <span class="n">gdal</span><span class="o">.</span><span class="n">Open</span><span class="p">(</span><span class="n">src_raster_file</span><span class="p">)</span>
    <span class="n">xform_ds</span> <span class="o">=</span> <span class="n">gdal</span><span class="o">.</span><span class="n">Open</span><span class="p">(</span><span class="n">xform_raster_file</span><span class="p">,</span> <span class="n">gdal</span><span class="o">.</span><span class="n">GA_Update</span><span class="p">)</span>
    <span class="n">src_band</span> <span class="o">=</span> <span class="n">src_ds</span><span class="o">.</span><span class="n">GetRasterBand</span><span class="p">(</span><span class="n">xform_band</span><span class="p">)</span>
    <span class="n">xform_band</span> <span class="o">=</span> <span class="n">xform_ds</span><span class="o">.</span><span class="n">GetRasterBand</span><span class="p">(</span><span class="n">xform_band</span><span class="p">)</span>
    <span class="n">ndv</span> <span class="o">=</span> <span class="n">src_band</span><span class="o">.</span><span class="n">GetNoDataValue</span><span class="p">()</span>
    <span class="n">sar</span><span class="p">,</span> <span class="n">xar</span> <span class="o">=</span> <span class="n">src_band</span><span class="o">.</span><span class="n">ReadAsArray</span><span class="p">(),</span> <span class="n">xform_band</span><span class="o">.</span><span class="n">ReadAsArray</span><span class="p">()</span>
    <span class="n">unchanged_mask</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">sar</span> <span class="o">-</span> <span class="n">xar</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mf">0.01</span><span class="p">)</span>
    <span class="n">src_band</span><span class="p">,</span> <span class="n">xform_band</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> <span class="kc">None</span>
    <span class="k">for</span> <span class="n">b</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">xform_ds</span><span class="o">.</span><span class="n">RasterCount</span><span class="o">+</span><span class="mi">1</span><span class="p">):</span>
        <span class="n">band</span> <span class="o">=</span> <span class="n">xform_ds</span><span class="o">.</span><span class="n">GetRasterBand</span><span class="p">(</span><span class="n">b</span><span class="p">)</span>
        <span class="n">bar</span> <span class="o">=</span> <span class="n">band</span><span class="o">.</span><span class="n">ReadAsArray</span><span class="p">()</span>
        <span class="n">bar</span><span class="p">[</span><span class="n">unchanged_mask</span><span class="p">]</span> <span class="o">=</span> <span class="n">ndv</span>
        <span class="n">band</span><span class="o">.</span><span class="n">WriteArray</span><span class="p">(</span><span class="n">bar</span><span class="p">)</span>
        <span class="n">xform_ds</span><span class="o">.</span><span class="n">GetRasterBand</span><span class="p">(</span><span class="n">b</span><span class="p">)</span><span class="o">.</span><span class="n">SetNoDataValue</span><span class="p">(</span><span class="n">ndv</span><span class="p">)</span>
        <span class="n">band</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="n">src_ds</span><span class="p">,</span> <span class="n">xform_ds</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> <span class="kc">None</span>
    <span class="k">return</span></div>



<div class="viewcode-block" id="raster_compress">
<a class="viewcode-back" href="../../../vyperdatum.utils.html#vyperdatum.utils.raster_utils.raster_compress">[docs]</a>
<span class="k">def</span> <span class="nf">raster_compress</span><span class="p">(</span><span class="n">raster_file_path</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
                    <span class="n">output_file_path</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
                    <span class="nb">format</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
                    <span class="n">compression</span><span class="p">:</span> <span class="nb">str</span>
                    <span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Compress raster file.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    raster_file_path: str</span>
<span class="sd">        absolute path to the input raster file.</span>
<span class="sd">    output_file_path: str</span>
<span class="sd">        absolute path to the compressed output raster file.</span>
<span class="sd">    format: str</span>
<span class="sd">        raster file format.</span>
<span class="sd">    compression: str</span>
<span class="sd">        compression algorithm.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">translate_kwargs</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;format&quot;</span><span class="p">:</span> <span class="nb">format</span><span class="p">,</span>
                        <span class="s2">&quot;creationOptions&quot;</span><span class="p">:</span> <span class="p">[</span><span class="sa">f</span><span class="s2">&quot;COMPRESS=</span><span class="si">{</span><span class="n">compression</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">]</span>
                        <span class="p">}</span>
    <span class="n">gtiff_co</span> <span class="o">=</span> <span class="p">[</span><span class="sa">f</span><span class="s2">&quot;BIGTIFF=</span><span class="si">{</span><span class="s1">&#39;YES&#39;</span><span class="w"> </span><span class="k">if</span><span class="w"> </span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">getsize</span><span class="p">(</span><span class="n">raster_file_path</span><span class="p">)</span><span class="w"> </span><span class="o">&gt;</span><span class="w"> </span><span class="mf">3e9</span><span class="w"> </span><span class="k">else</span><span class="w"> </span><span class="s1">&#39;IF_NEEDED&#39;</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span>
                <span class="s2">&quot;TILED=YES&quot;</span><span class="p">]</span>

    <span class="k">if</span> <span class="nb">format</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span> <span class="o">==</span> <span class="s2">&quot;gtiff&quot;</span><span class="p">:</span>
        <span class="n">translate_kwargs</span><span class="p">[</span><span class="s2">&quot;creationOptions&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span><span class="n">gtiff_co</span><span class="p">)</span>
    <span class="n">gdal</span><span class="o">.</span><span class="n">Translate</span><span class="p">(</span><span class="n">output_file_path</span><span class="p">,</span> <span class="n">raster_file_path</span><span class="p">,</span> <span class="o">**</span><span class="n">translate_kwargs</span><span class="p">)</span>
    <span class="k">return</span></div>



<div class="viewcode-block" id="crs_to_code_auth">
<a class="viewcode-back" href="../../../vyperdatum.utils.html#vyperdatum.utils.raster_utils.crs_to_code_auth">[docs]</a>
<span class="k">def</span> <span class="nf">crs_to_code_auth</span><span class="p">(</span><span class="n">crs</span><span class="p">:</span> <span class="n">pp</span><span class="o">.</span><span class="n">CRS</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Return CRS string representation in form of code:authority</span>

<span class="sd">    Raises</span>
<span class="sd">    -------</span>
<span class="sd">    ValueError:</span>
<span class="sd">        If either code of authority of the crs (or its sub_crs) can not be determined.</span>

<span class="sd">    Returns</span>
<span class="sd">    --------</span>
<span class="sd">    str:</span>
<span class="sd">        crs string in form of code:authority</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">def</span> <span class="nf">get_code_auth</span><span class="p">(</span><span class="n">_crs</span><span class="p">:</span> <span class="n">pp</span><span class="o">.</span><span class="n">CRS</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">_crs</span><span class="o">.</span><span class="n">to_authority</span><span class="p">(</span><span class="n">min_confidence</span><span class="o">=</span><span class="mi">100</span><span class="p">):</span>
            <span class="k">return</span> <span class="s2">&quot;:&quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">_crs</span><span class="o">.</span><span class="n">to_authority</span><span class="p">(</span><span class="n">min_confidence</span><span class="o">=</span><span class="mi">100</span><span class="p">))</span>
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Unable to produce authority name and code for this crs:</span><span class="se">\n</span><span class="si">{</span><span class="n">_crs</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">crs</span><span class="o">.</span><span class="n">is_compound</span><span class="p">:</span>
        <span class="n">hcrs</span> <span class="o">=</span> <span class="n">pp</span><span class="o">.</span><span class="n">CRS</span><span class="p">(</span><span class="n">crs</span><span class="o">.</span><span class="n">sub_crs_list</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
        <span class="n">vcrs</span> <span class="o">=</span> <span class="n">pp</span><span class="o">.</span><span class="n">CRS</span><span class="p">(</span><span class="n">crs</span><span class="o">.</span><span class="n">sub_crs_list</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>
        <span class="n">code_auth</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">get_code_auth</span><span class="p">(</span><span class="n">hcrs</span><span class="p">)</span><span class="si">}</span><span class="s2">+</span><span class="si">{</span><span class="n">get_code_auth</span><span class="p">(</span><span class="n">vcrs</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">code_auth</span> <span class="o">=</span> <span class="n">get_code_auth</span><span class="p">(</span><span class="n">crs</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">code_auth</span></div>



<div class="viewcode-block" id="warp">
<a class="viewcode-back" href="../../../vyperdatum.utils.html#vyperdatum.utils.raster_utils.warp">[docs]</a>
<span class="k">def</span> <span class="nf">warp</span><span class="p">(</span><span class="n">input_file</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
         <span class="n">output_file</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
         <span class="n">apply_vertical</span><span class="p">:</span> <span class="nb">bool</span><span class="p">,</span>
         <span class="n">crs_from</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span><span class="n">pp</span><span class="o">.</span><span class="n">CRS</span><span class="p">,</span> <span class="nb">str</span><span class="p">],</span>
         <span class="n">crs_to</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span><span class="n">pp</span><span class="o">.</span><span class="n">CRS</span><span class="p">,</span> <span class="nb">str</span><span class="p">],</span>
         <span class="n">input_metadata</span><span class="p">:</span> <span class="nb">dict</span><span class="p">,</span>
         <span class="n">warp_kwargs</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">dict</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span>
         <span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    A gdal-warp wrapper to transform an NBS raster (GTiff) file with 3 bands:</span>
<span class="sd">    Elevation, Uncertainty, and Contributors.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    input_file: str</span>
<span class="sd">        Path to the input raster file (gdal supported).</span>
<span class="sd">    output_file: str</span>
<span class="sd">        Path to the transformed raster file.</span>
<span class="sd">    apply_vertical: bool</span>
<span class="sd">        Apply GDAL vertical shift.</span>
<span class="sd">    crs_from: pyproj.crs.CRS or input used to create one</span>
<span class="sd">        Projection of input data.</span>
<span class="sd">    crs_to: pyproj.crs.CRS or input used to create one</span>
<span class="sd">        Projection of output data.</span>
<span class="sd">    input_metadata: dict</span>
<span class="sd">        Dictionary containing metadata generated by vyperdatum.raster_utils.raster_metadata()</span>
<span class="sd">    warp_kwargs: dict</span>
<span class="sd">        gdal kwargs.</span>

<span class="sd">    Returns</span>
<span class="sd">    --------</span>
<span class="sd">    str:</span>
<span class="sd">        Absolute path to the transformed file.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">crs_from</span><span class="p">,</span> <span class="n">pp</span><span class="o">.</span><span class="n">CRS</span><span class="p">):</span>
        <span class="n">crs_from</span> <span class="o">=</span> <span class="n">crs_to_code_auth</span><span class="p">(</span><span class="n">crs_from</span><span class="p">)</span>
    <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">crs_to</span><span class="p">,</span> <span class="n">pp</span><span class="o">.</span><span class="n">CRS</span><span class="p">):</span>
        <span class="n">crs_to</span> <span class="o">=</span> <span class="n">crs_to_code_auth</span><span class="p">(</span><span class="n">crs_to</span><span class="p">)</span>

    <span class="n">gdal</span><span class="o">.</span><span class="n">Warp</span><span class="p">(</span><span class="n">output_file</span><span class="p">,</span>
              <span class="n">input_file</span><span class="p">,</span>
              <span class="n">dstSRS</span><span class="o">=</span><span class="n">crs_to</span><span class="p">,</span>
              <span class="n">srcSRS</span><span class="o">=</span><span class="n">crs_from</span><span class="p">,</span>
              <span class="c1"># xRes=input_metadata[&quot;resolution&quot;][0],</span>
              <span class="c1"># yRes=abs(input_metadata[&quot;resolution&quot;][1]),</span>
              <span class="c1"># outputBounds=input_metadata[&quot;extent&quot;],</span>
              <span class="o">**</span><span class="p">(</span><span class="n">warp_kwargs</span> <span class="ow">or</span> <span class="p">{})</span>
              <span class="p">)</span>

    <span class="k">if</span> <span class="n">apply_vertical</span><span class="p">:</span>
        <span class="c1"># horizontal CRS MUST be identical for both source and target</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">warp_kwargs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;srcBands&quot;</span><span class="p">),</span> <span class="nb">list</span><span class="p">):</span>
            <span class="n">ds_in</span> <span class="o">=</span> <span class="n">gdal</span><span class="o">.</span><span class="n">Open</span><span class="p">(</span><span class="n">input_file</span><span class="p">,</span> <span class="n">gdal</span><span class="o">.</span><span class="n">GA_ReadOnly</span><span class="p">)</span>
            <span class="n">ds_out</span> <span class="o">=</span> <span class="n">gdal</span><span class="o">.</span><span class="n">Open</span><span class="p">(</span><span class="n">output_file</span><span class="p">,</span> <span class="n">gdal</span><span class="o">.</span><span class="n">GA_ReadOnly</span><span class="p">)</span>
            <span class="c1"># combine the vertically transformed bands and</span>
            <span class="c1"># the non-transformed ones into a new raster</span>
            <span class="n">driver</span> <span class="o">=</span> <span class="n">gdal</span><span class="o">.</span><span class="n">GetDriverByName</span><span class="p">(</span><span class="n">input_metadata</span><span class="p">[</span><span class="s2">&quot;driver&quot;</span><span class="p">])</span>
            <span class="n">mem_path</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;/vsimem/</span><span class="si">{</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">splitext</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">basename</span><span class="p">(</span><span class="n">output_file</span><span class="p">))[</span><span class="mi">0</span><span class="p">]</span><span class="si">}</span><span class="s2">.tiff&quot;</span>
            <span class="n">ds_temp</span> <span class="o">=</span> <span class="n">driver</span><span class="o">.</span><span class="n">Create</span><span class="p">(</span><span class="n">mem_path</span><span class="p">,</span>
                                    <span class="n">ds_in</span><span class="o">.</span><span class="n">RasterXSize</span><span class="p">,</span>
                                    <span class="n">ds_in</span><span class="o">.</span><span class="n">RasterYSize</span><span class="p">,</span>
                                    <span class="n">ds_in</span><span class="o">.</span><span class="n">RasterCount</span><span class="p">,</span>
                                    <span class="n">gdal</span><span class="o">.</span><span class="n">GDT_Float32</span>
                                    <span class="p">)</span>
            <span class="n">ds_temp</span><span class="o">.</span><span class="n">SetGeoTransform</span><span class="p">(</span><span class="n">ds_out</span><span class="o">.</span><span class="n">GetGeoTransform</span><span class="p">())</span>
            <span class="n">ds_temp</span><span class="o">.</span><span class="n">SetProjection</span><span class="p">(</span><span class="n">ds_out</span><span class="o">.</span><span class="n">GetProjection</span><span class="p">())</span>
            <span class="k">for</span> <span class="n">b</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">ds_in</span><span class="o">.</span><span class="n">RasterCount</span><span class="o">+</span><span class="mi">1</span><span class="p">):</span>
                <span class="k">if</span> <span class="n">b</span> <span class="ow">in</span> <span class="n">warp_kwargs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;srcBands&quot;</span><span class="p">):</span>
                    <span class="n">out_shape</span> <span class="o">=</span> <span class="n">ds_out</span><span class="o">.</span><span class="n">GetRasterBand</span><span class="p">(</span><span class="n">b</span><span class="p">)</span><span class="o">.</span><span class="n">ReadAsArray</span><span class="p">()</span><span class="o">.</span><span class="n">shape</span>
                    <span class="n">in_shape</span> <span class="o">=</span> <span class="n">ds_in</span><span class="o">.</span><span class="n">GetRasterBand</span><span class="p">(</span><span class="n">b</span><span class="p">)</span><span class="o">.</span><span class="n">ReadAsArray</span><span class="p">()</span><span class="o">.</span><span class="n">shape</span>
                    <span class="k">if</span> <span class="n">out_shape</span> <span class="o">!=</span> <span class="n">in_shape</span><span class="p">:</span>
                        <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Band </span><span class="si">{</span><span class="n">b</span><span class="si">}</span><span class="s2"> dimensions has changed from&quot;</span>
                                     <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">in_shape</span><span class="si">}</span><span class="s2"> to </span><span class="si">{</span><span class="n">out_shape</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
                    <span class="n">ds_temp</span><span class="o">.</span><span class="n">GetRasterBand</span><span class="p">(</span><span class="n">b</span><span class="p">)</span><span class="o">.</span><span class="n">WriteArray</span><span class="p">(</span><span class="n">ds_out</span><span class="o">.</span><span class="n">GetRasterBand</span><span class="p">(</span><span class="n">b</span><span class="p">)</span><span class="o">.</span><span class="n">ReadAsArray</span><span class="p">())</span>
                    <span class="n">ds_temp</span><span class="o">.</span><span class="n">GetRasterBand</span><span class="p">(</span><span class="n">b</span><span class="p">)</span><span class="o">.</span><span class="n">SetDescription</span><span class="p">(</span><span class="n">ds_out</span><span class="o">.</span><span class="n">GetRasterBand</span><span class="p">(</span><span class="n">b</span><span class="p">)</span><span class="o">.</span><span class="n">GetDescription</span><span class="p">())</span>
                    <span class="n">ds_temp</span><span class="o">.</span><span class="n">GetRasterBand</span><span class="p">(</span><span class="n">b</span><span class="p">)</span><span class="o">.</span><span class="n">SetNoDataValue</span><span class="p">(</span><span class="n">ds_out</span><span class="o">.</span><span class="n">GetRasterBand</span><span class="p">(</span><span class="n">b</span><span class="p">)</span><span class="o">.</span><span class="n">GetNoDataValue</span><span class="p">())</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">ds_temp</span><span class="o">.</span><span class="n">GetRasterBand</span><span class="p">(</span><span class="n">b</span><span class="p">)</span><span class="o">.</span><span class="n">WriteArray</span><span class="p">(</span><span class="n">ds_in</span><span class="o">.</span><span class="n">GetRasterBand</span><span class="p">(</span><span class="n">b</span><span class="p">)</span><span class="o">.</span><span class="n">ReadAsArray</span><span class="p">())</span>
                    <span class="n">ds_temp</span><span class="o">.</span><span class="n">GetRasterBand</span><span class="p">(</span><span class="n">b</span><span class="p">)</span><span class="o">.</span><span class="n">SetDescription</span><span class="p">(</span><span class="n">ds_in</span><span class="o">.</span><span class="n">GetRasterBand</span><span class="p">(</span><span class="n">b</span><span class="p">)</span><span class="o">.</span><span class="n">GetDescription</span><span class="p">())</span>
                    <span class="n">ds_temp</span><span class="o">.</span><span class="n">GetRasterBand</span><span class="p">(</span><span class="n">b</span><span class="p">)</span><span class="o">.</span><span class="n">SetNoDataValue</span><span class="p">(</span><span class="n">ds_in</span><span class="o">.</span><span class="n">GetRasterBand</span><span class="p">(</span><span class="n">b</span><span class="p">)</span><span class="o">.</span><span class="n">GetNoDataValue</span><span class="p">())</span>
            <span class="n">ds_in</span><span class="p">,</span> <span class="n">ds_out</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> <span class="kc">None</span>
            <span class="n">ds_temp</span><span class="o">.</span><span class="n">FlushCache</span><span class="p">()</span>
            <span class="n">driver</span><span class="o">.</span><span class="n">CreateCopy</span><span class="p">(</span><span class="n">output_file</span><span class="p">,</span> <span class="n">ds_temp</span><span class="p">)</span>
            <span class="n">ds_temp</span> <span class="o">=</span> <span class="kc">None</span>
            <span class="n">gdal</span><span class="o">.</span><span class="n">Unlink</span><span class="p">(</span><span class="n">mem_path</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">input_metadata</span><span class="p">[</span><span class="s2">&quot;compression&quot;</span><span class="p">]</span> <span class="ow">and</span> <span class="n">input_metadata</span><span class="p">[</span><span class="s2">&quot;driver&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span> <span class="o">==</span> <span class="s2">&quot;gtiff&quot;</span><span class="p">:</span>
        <span class="n">output_file_copy</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">output_file</span><span class="p">)</span><span class="o">+</span><span class="s2">&quot;.tmp&quot;</span>
        <span class="n">os</span><span class="o">.</span><span class="n">rename</span><span class="p">(</span><span class="n">output_file</span><span class="p">,</span> <span class="n">output_file_copy</span><span class="p">)</span>
        <span class="n">raster_compress</span><span class="p">(</span><span class="n">output_file_copy</span><span class="p">,</span> <span class="n">output_file</span><span class="p">,</span>
                        <span class="n">input_metadata</span><span class="p">[</span><span class="s2">&quot;driver&quot;</span><span class="p">],</span> <span class="n">input_metadata</span><span class="p">[</span><span class="s1">&#39;compression&#39;</span><span class="p">]</span>
                        <span class="p">)</span>
        <span class="n">os</span><span class="o">.</span><span class="n">remove</span><span class="p">(</span><span class="n">output_file_copy</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">output_file</span></div>



<div class="viewcode-block" id="pre_transformation_checks">
<a class="viewcode-back" href="../../../vyperdatum.utils.html#vyperdatum.utils.raster_utils.pre_transformation_checks">[docs]</a>
<span class="k">def</span> <span class="nf">pre_transformation_checks</span><span class="p">(</span><span class="n">source_meta</span><span class="p">:</span> <span class="nb">dict</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Run a number of sanity checks on the source raster file, before transformation.</span>
<span class="sd">    Warns if a check fails.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    source_meta: dict</span>
<span class="sd">        Source raster metadata generated by `raster_metadata` function.</span>

<span class="sd">    Returns</span>
<span class="sd">    ----------</span>
<span class="sd">    bool</span>
<span class="sd">        Returns True if all checks pass, otherwise False.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">passed</span> <span class="o">=</span> <span class="kc">True</span>
    <span class="k">if</span> <span class="n">source_meta</span><span class="p">[</span><span class="s2">&quot;bands&quot;</span><span class="p">]</span> <span class="o">!=</span> <span class="mi">3</span><span class="p">:</span>
        <span class="n">passed</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="s2">&quot;&gt;&gt;&gt;&gt;&gt; Warning &lt;&lt;&lt;&lt;&lt; Number of bands in the raster file: &quot;</span>
                       <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">source_meta</span><span class="p">[</span><span class="s1">&#39;bands&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2">. NBS rasters typically contain 3 bands&quot;</span><span class="p">)</span>
    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">source_meta</span><span class="p">[</span><span class="s2">&quot;overlapping_regions&quot;</span><span class="p">])</span> <span class="o">!=</span> <span class="mi">1</span><span class="p">:</span>
        <span class="n">passed</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="s2">&quot;&gt;&gt;&gt;&gt;&gt; Warning &lt;&lt;&lt;&lt;&lt; The raster is not overlapping with a single region. &quot;</span>
                       <span class="sa">f</span><span class="s2">&quot;The overlapping regions: (</span><span class="si">{</span><span class="n">source_meta</span><span class="p">[</span><span class="s1">&#39;overlapping_regions&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2">).&quot;</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">passed</span></div>



<div class="viewcode-block" id="post_transformation_checks">
<a class="viewcode-back" href="../../../vyperdatum.utils.html#vyperdatum.utils.raster_utils.post_transformation_checks">[docs]</a>
<span class="k">def</span> <span class="nf">post_transformation_checks</span><span class="p">(</span><span class="n">source_meta</span><span class="p">:</span> <span class="nb">dict</span><span class="p">,</span>
                               <span class="n">target_meta</span><span class="p">:</span> <span class="nb">dict</span><span class="p">,</span>
                               <span class="n">target_crs</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span><span class="n">pp</span><span class="o">.</span><span class="n">CRS</span><span class="p">,</span> <span class="nb">str</span><span class="p">],</span>
                               <span class="n">vertical_transform</span><span class="p">:</span> <span class="nb">bool</span>
                               <span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Run a number of sanity checks on the transformed raster file.</span>
<span class="sd">    Warns if a check fails.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    source_meta: dict</span>
<span class="sd">        Source raster metadata generated by `raster_metadata` function.</span>
<span class="sd">    target_meta: dict</span>
<span class="sd">        Target raster metadata generated by `raster_metadata` function.</span>
<span class="sd">    target_crs:  pyproj.crs.CRS or input used to create one</span>
<span class="sd">        The expected CRS object for the target raster file.</span>
<span class="sd">    vertical_transform: bool</span>
<span class="sd">        True if it&#39;s a vertical transformation, otherwise False.</span>

<span class="sd">    Returns</span>
<span class="sd">    ----------</span>
<span class="sd">    bool</span>
<span class="sd">        Returns True if all checks pass, otherwise False.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="o">~</span><span class="nb">isinstance</span><span class="p">(</span><span class="n">target_crs</span><span class="p">,</span> <span class="n">pp</span><span class="o">.</span><span class="n">CRS</span><span class="p">):</span>
        <span class="n">target_crs</span> <span class="o">=</span> <span class="n">pp</span><span class="o">.</span><span class="n">CRS</span><span class="p">(</span><span class="n">target_crs</span><span class="p">)</span>
    <span class="n">passed</span> <span class="o">=</span> <span class="kc">True</span>
    <span class="n">target_auth</span> <span class="o">=</span> <span class="n">target_crs</span><span class="o">.</span><span class="n">to_authority</span><span class="p">()</span>
    <span class="n">transformed_auth</span> <span class="o">=</span> <span class="n">pp</span><span class="o">.</span><span class="n">CRS</span><span class="p">(</span><span class="n">target_meta</span><span class="p">[</span><span class="s2">&quot;wkt&quot;</span><span class="p">])</span><span class="o">.</span><span class="n">to_authority</span><span class="p">()</span>
    <span class="k">if</span> <span class="n">target_auth</span> <span class="o">!=</span> <span class="n">transformed_auth</span><span class="p">:</span>
        <span class="n">passed</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="s2">&quot;&gt;&gt;&gt;&gt;&gt; Warning &lt;&lt;&lt;&lt;&lt; The expected authority code/name of the &quot;</span>
                       <span class="sa">f</span><span class="s2">&quot;transformed raster is </span><span class="si">{</span><span class="n">target_auth</span><span class="si">}</span><span class="s2">, but received </span><span class="si">{</span><span class="n">transformed_auth</span><span class="si">}</span><span class="s2">&quot;</span>
                       <span class="p">)</span>
    <span class="k">if</span> <span class="n">source_meta</span><span class="p">[</span><span class="s2">&quot;bands&quot;</span><span class="p">]</span> <span class="o">!=</span> <span class="n">target_meta</span><span class="p">[</span><span class="s2">&quot;bands&quot;</span><span class="p">]:</span>
        <span class="n">passed</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="s2">&quot;&gt;&gt;&gt;&gt;&gt; Warning &lt;&lt;&lt;&lt;&lt; Number of bands in the source file &quot;</span>
                       <span class="sa">f</span><span class="s2">&quot;(</span><span class="si">{</span><span class="n">source_meta</span><span class="p">[</span><span class="s1">&#39;bands&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2">) doesn&#39;t match target (</span><span class="si">{</span><span class="n">target_meta</span><span class="p">[</span><span class="s1">&#39;bands&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2">).&quot;</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">vertical_transform</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">source_meta</span><span class="p">[</span><span class="s2">&quot;dimensions&quot;</span><span class="p">]</span> <span class="o">!=</span> <span class="n">target_meta</span><span class="p">[</span><span class="s2">&quot;dimensions&quot;</span><span class="p">]:</span>
            <span class="n">passed</span> <span class="o">=</span> <span class="kc">False</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="s2">&quot;&gt;&gt;&gt;&gt;&gt; Warning &lt;&lt;&lt;&lt;&lt; The source file band dimensions &quot;</span>
                           <span class="sa">f</span><span class="s2">&quot; (</span><span class="si">{</span><span class="n">source_meta</span><span class="p">[</span><span class="s1">&#39;dimensions&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2">) don&#39;t match those of the &quot;</span>
                           <span class="sa">f</span><span class="s2">&quot;transformed file (</span><span class="si">{</span><span class="n">target_meta</span><span class="p">[</span><span class="s1">&#39;dimensions&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2">).&quot;</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">source_meta</span><span class="p">[</span><span class="s2">&quot;resolution&quot;</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span> <span class="o">!=</span> <span class="n">target_meta</span><span class="p">[</span><span class="s2">&quot;resolution&quot;</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span> <span class="ow">or</span> <span class="n">source_meta</span><span class="p">[</span><span class="s2">&quot;resolution&quot;</span><span class="p">][</span><span class="mi">1</span><span class="p">]</span> <span class="o">!=</span> <span class="n">target_meta</span><span class="p">[</span><span class="s2">&quot;resolution&quot;</span><span class="p">][</span><span class="mi">1</span><span class="p">]:</span>
            <span class="n">passed</span> <span class="o">=</span> <span class="kc">False</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="s2">&quot;&gt;&gt;&gt;&gt;&gt; Warning &lt;&lt;&lt;&lt;&lt; The source file pixel size &quot;</span>
                           <span class="sa">f</span><span class="s2">&quot; (</span><span class="si">{</span><span class="n">source_meta</span><span class="p">[</span><span class="s1">&#39;resolution&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2">) don&#39;t match those of the &quot;</span>
                           <span class="sa">f</span><span class="s2">&quot;transformed file (</span><span class="si">{</span><span class="n">target_meta</span><span class="p">[</span><span class="s1">&#39;resolution&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2">).&quot;</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">passed</span></div>

</pre></div>

           </div>
          </div>
          <footer>

  <hr/>

  <div role="contentinfo">
    <p>&#169; Copyright 2024, Mohammad Ashkezari.</p>
  </div>

  Built with <a href="https://www.sphinx-doc.org/">Sphinx</a> using a
    <a href="https://github.com/readthedocs/sphinx_rtd_theme">theme</a>
    provided by <a href="https://readthedocs.org">Read the Docs</a>.
   

</footer>
        </div>
      </div>
    </section>
  </div>
  <script>
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script> 

</body>
</html>